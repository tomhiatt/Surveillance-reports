---
title: 'Epidemiology and control of tuberculosis in the Western Pacific Region: update
  with `r yr <- 2013; yr` case notification data'
author: "Tom Hiatt<sup>&dagger;</sup> and Nobuyuki Nishikiori<sup>&dagger;</sup>"
csl: vancouver-imperial-college-london.csl
output:
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: no
    theme: united
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    fig_height: 7
bibliography: WPRupdate.bib
---

```{r setup, echo=FALSE, include=FALSE}

###################################################
# Tom Hiatt
# Updated: 20 November 2015
# Regional TB annual analysis
###################################################

yr <- 2013

###################################################

# > sessionInfo()

library(plyr) #Note: plyr must be loaded before dplyr
lapply(c("reshape", "plyr", "dplyr", "ggplot2", "grid", "scales", "xtable", "stringr", "ggthemes", "tidyr"), library, character.only=TRUE)

# Reproducible research process inspired by: http://gforge.se/2014/01/fast-track-publishing-using-knitr-part-ii/

# Global options for knitr
# change this to 'postscript' for EPS output.
require(knitr)
opts_chunk$set(
  #   dev="png",
  #   dev.args=list(type="cairo"),
  #   dpi=96,
  fig.width=7,
  echo=FALSE,
  message=FALSE
  )

whbc <- c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM")

# Create regional report folder if needed.
# dir.create("./Regional_report") # run this if error below
# dir.create("./figure_data") # run this if error below
if(!any(grep("Regional_report", getwd()))) setwd("./Regional_report")


# Theme for plots
theme_report <- function(base_size=12, base_family="") {
  colors <- ggthemes_data$few
  gray <- colors$medium['gray']
  black <- colors$dark['black'] # I don't know why these last 3 parts are needed, but they are. List is here: http://docs.ggplot2.org/0.9.2.1/theme.html
  theme_bw(base_size=base_size, base_family=base_family) +
    theme(
      line = element_line(colour = gray),
      rect = element_rect(fill = "white", colour = NA),
      text = element_text(colour = black),
      axis.ticks.x = element_line(colour = gray),
      axis.ticks.y = element_blank(),
      legend.key = element_rect(colour = NA),
      ## Examples do not use grid lines
      panel.border = element_rect(colour = gray),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      strip.background = element_rect(fill="white", colour=NA),
      strip.text = element_text(hjust=0)
      )
  }

########################################################
# Functions for data formatting and manipulation
########################################################

# Simple rounder that just adds in the thousands separator 
rounder <- function(x, decimals=FALSE) {
  if(decimals==TRUE){
    ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 0.01, "<0.01", ifelse(round(x,2) < 0.1, formatC(round(x,2), format='f', digits=2), ifelse(round(x,1) < 10, formatC(round(x,1), format='f', digits=1), formatC(round(x,0), big.mark=" ", format='d') )))))
    }
  else ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 1, "< 1", formatC(round(x,0), big.mark=" ", format='d'))))
  }

.rowsums <- function(x) { 
  # This function sums rows ignoring NAs unless all are NA
  # use it like this
  # t3c$snu <- .rowsums(t3c[c('new_sn', 'new_su')])
  tosum <- as.matrix(x)
  summed <- rowMeans((tosum), na.rm=T) * rowSums(!is.na((tosum)))
  return(summed)
  }

sum0 <- function(x) sum(x, na.rm = !all(is.na(x)))

rowSumsNA2 <- function(df, new.var="new.var", cols, ...) {
   # remove NAs unless all are NA
  df2 <- df[cols]
   df[new.var] <- rowMeans(df2, na.rm=TRUE) * rowSums(!is.na(df2))
  return(df)
 }

# For adding labels to the right side of a line plot
spacer <- function(x, max1=max(x), min.spread=3){
  x1 <- unlist(x)
  x2 <- x1[order(x1, decreasing = TRUE)]
  y <- max1
  for(item in x2[2:length(x2)]){
#     if(is.null(y)) y[1] <- item
    if(y[length(y)] - item < min.spread) y[length(y)+1] <- y[length(y)] - min.spread
    else(y[length(y)+1] <- item) 
  }
  y1 <- y[order(order(x1, decreasing = TRUE))]
  return(y1)
}

end.labels <- function(df, xaxis, yaxis, ...){
  df1 <- df[df[xaxis]==max(df[xaxis]),]
  df1[yaxis] <- spacer(df1[yaxis], ...)
  return(df1)
}


# Change names to WPSAR convention
.WPSARnames <- function(d, col='country', the=FALSE){
  d[col] <- as.character(d[[col]])
  d[col] <- ifelse(d[[col]]=='China, Hong Kong SAR', 'Hong Kong Special Administrative Region (China)', 
                   ifelse(d[[col]]=='China, Macao SAR', 'Macao Special Administrative Region (China)', 
                          ifelse(d[[col]]=='Micronesia (Federated States of)', 'Micronesia, Federated States of', 
                                 ifelse(d[[col]]=='WPR', 'Western Pacific Region
                                        ', d[[col]]))))
  
  if(the){
    d[col] <- ifelse(d[[col]]=='Philippines', 'the Philippines',
                     ifelse(d[[col]]=="Lao People's Democratic Republic", "the Lao People's Democratic Republic", d[[col]]))
    }
  
  
  return(d)
  }

# For adding an x-axis to orphaned plots -----------------------------
facetAdjust <- function(x, pos = c("up", "down"))
{
  pos <- match.arg(pos)
  p <- ggplot_build(x)
  gtable <- ggplot_gtable(p); dev.off()
  dims <- apply(p$panel$layout[2:3], 2, max)
  nrow <- dims[1]
  ncol <- dims[2]
  panels <- sum(grepl("panel", names(gtable$grobs)))
  space <- ncol * nrow
  n <- space - panels
  if(panels != space){
    idx <- (space - ncol - n + 1):(space - ncol)
    gtable$grobs[paste0("axis_b",idx)] <- list(gtable$grobs[[paste0("axis_b",panels)]])
    if(pos == "down"){
      rows <- grep(paste0("axis_b\\-[", idx[1], "-", idx[n], "]"), 
                   gtable$layout$name)
      lastAxis <- grep(paste0("axis_b\\-", panels), gtable$layout$name)
      gtable$layout[rows, c("t","b")] <- gtable$layout[lastAxis, c("t")]
    }
  }
  class(gtable) <- c("facetAdjust", "gtable", "ggplot"); gtable
}
# The function for printing which differs only by few lines from ggplot2:::print.ggplot:
print.facetAdjust <- function(x, newpage = is.null(vp), vp = NULL) {
  if(newpage)
    grid.newpage()
  if(is.null(vp)){
    grid.draw(x)
  } else {
    if (is.character(vp)) 
      seekViewport(vp)
    else pushViewport(vp)
    grid.draw(x)
    upViewport()
  }
  invisible(x)
}

########################################################
# Functions for text manipulation
########################################################

num.adverb <- function(x, direction=c("none", "up", "down"), sigfigs=2){
  if(direction=="none") return(paste("approximately", signif(x,sigfigs)))
  range <- pretty(x, n=2)
  if(direction=="up") return(NA)
  
}

numbers2words <- function(x){
  ## Function by John Fox found here: 
  ## http://tolstoy.newcastle.edu.au/R/help/05/04/2715.html
  
  helper <- function(x){
    
    digits <- rev(strsplit(as.character(x), "")[[1]])
    nDigits <- length(digits)
    if (nDigits == 1) as.vector(ones[digits])
    else if (nDigits == 2)
      if (x <= 19) as.vector(teens[digits[1]])
    else trim(paste(tens[digits[2]],
                    Recall(as.numeric(digits[1]))))
    else if (nDigits == 3) trim(paste(ones[digits[3]], "hundred", 
                                      Recall(makeNumber(digits[2:1]))))
    else {
      nSuffix <- ((nDigits + 2) %/% 3) - 1
      if (nSuffix > length(suffixes)) stop(paste(x, "is too large!"))
      trim(paste(Recall(makeNumber(digits[
        nDigits:(3*nSuffix + 1)])),
                 suffixes[nSuffix],  
                 Recall(makeNumber(digits[(3*nSuffix):1]))))
    }
  }
  trim <- function(text){
    gsub("^\ ", "", gsub("\ *$", "", text))
  }  
  makeNumber <- function(...) as.numeric(paste(..., collapse=""))     
  opts <- options(scipen=100) 
  on.exit(options(opts)) 
  ones <- c("", "one", "two", "three", "four", "five", "six", "seven",
            "eight", "nine") 
  names(ones) <- 0:9 
  teens <- c("ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
             "sixteen", " seventeen", "eighteen", "nineteen")
  names(teens) <- 0:9 
  tens <- c("twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty",
            "ninety") 
  names(tens) <- 2:9 
  x <- round(x)
  suffixes <- c("thousand", "million", "billion", "trillion")     
  if (length(x) > 1) return(sapply(x, helper))     
  helper(x) 
}

########################################################
# Functions for maps
########################################################

source("./MapFunctions.r")
load("gparts.Rdata")

########################################################
# Functions to assist with tables and figure in markdown document (from here: http://rmflight.github.io/posts/2012/10/papersinRmd.html)
########################################################

incCount <- function(inObj, useName) {
  nObj <- length(inObj)
  useNum <- max(inObj) + 1
  inObj <- c(inObj, useNum)
  names(inObj)[nObj + 1] <- useName
  inObj
  }
figCount <- c(`_` = 0)
tableCount <- c(`_` = 0)

# tableCount

pasteLabel <- function(preText, inObj, objName, insLink = TRUE, sepper = " ") {
  objNum <- inObj[objName]
  
  useText <- paste(preText, objNum, sep = sepper)
  if (insLink) {
    useText <- paste("[", useText, "](#", objName, ")", sep = "")
  }
  useText
}

tableCat <- function(inFrame) {
  outText <- paste(names(inFrame), collapse = " | ")
  outText <- c(outText, paste(rep("---", ncol(inFrame)), collapse = " | "))
  invisible(apply(inFrame, 1, function(inRow) {
    outText <<- c(outText, paste(inRow, collapse = " | "))
    }))
  return(outText)
  }

a.rate <- function(start=NA, end=NA, years, prop=NA){
  # S * (1+P)^Y = F   |     P = (F/S)^(1/Y)-1
  # Leave start, end, or prop blank. Function will fill it in. Percent is the percent increase (+) or decrease (-) per year. Years is the last year minus the first.
  if(is.na(end)) return(start * (1+prop) ^ years)
  if(is.na(start)) return(end / (1+prop) ^ years)
  if(is.na(prop)) return((end / start) ^ (1/years)-1)
    else(stop("Gimme 2 of 'em, but don't give me 3."))
}

# Create directory and Get data

if(!"data" %in% dir()){
  dir.create(paste("./data"))
  stop("Download the notification and treatment outcomes data from 'http://who.int/tb/country/data/download/en/' to './data'.")
  }

data1 <- dir("./data", full.names=TRUE)
tb <- NA
for(i in data1){
  data3 <- read.csv(i)
  tb <- merge(tb, data3, all=TRUE)
  }

# Note: to use your own data, make a flat data file with each row corresponding to the lower reporting unit and a aggregating variable. EG by country with aggregating variable of region.

# Add needed variables
tb$g_hbc22 <- ifelse(tb$iso3 %in% c("AFG", "BGD", "BRA", "CHN", "COD", "ETH", "IDN", "IND", "KEN", "KHM", "MMR", "MOZ", "NGA", "PAK", "PHL", "RUS", "THA", "TZA", "UGA", "VNM", "ZAF", "ZWE"), "high", "low")

# tb$c_new <- .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth")])
# tb$c_newinc <- ifelse(tb$year < 2013, .rowsums(tb[c("tot_newrel", "newret_oth")]), .rowsums(tb[c("new_labconf", "new_clindx", "new_ep", "ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep")]))
# tb$c_ret <- .rowsums(tb[c("ret_rel", "ret_taf", "ret_tad", "ret_oth")])
tb$c_notified <- ifelse(tb$year < 2013, .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth", "ret_rel", "ret_taf", "ret_tad", "ret_oth", "newret_oth")]), .rowsums(tb[c("c_newinc", "ret_nrel")]))
tb$c_newrel_tsr <- tb$newrel_succ / tb$newrel_coh * 100

# tb$c_newinc_100k <- tb$c_newinc / tb$e_pop_num * 1e5

# Get population data (available from UN population division. http://esa.un.org/unpd/wpp/unpp/panel_population.htm) and formatted TB/HIV data and estimates for the WHO Western Pacific Region.

if(FALSE){
  runprofile()
  esta <- subset(araw, group_name=="WPR", select=c("year", "e_pop_num", "e_inc_100k", "e_inc_100k_lo", "e_inc_100k_hi", "e_prev_100k", "e_prev_100k_lo", "e_prev_100k_hi", "e_mort_exc_tbhiv_100k", "e_mort_exc_tbhiv_100k_lo", "e_mort_exc_tbhiv_100k_hi", "e_prev_num", "e_prev_num_lo", "e_prev_num_hi", "e_inc_tbhiv_num", "e_inc_tbhiv_num_lo", "e_inc_tbhiv_num_hi", "e_mort_exc_tbhiv_num", "e_inc_num"))
  save(esta, p, tbhiv, file="./addata.Rdata")
}

load("./addata.Rdata")

tb <- merge(tb, tbhiv[c(3,4,13:ncol(tbhiv))], all=TRUE)

```


<sup>&dagger;</sup> Stop TB and Leprosy Elimination, Division of Communicable Diseases, World Health Organization Regional Office for the Western Pacific, Manila, Philippines.

--------------------------------------------------------

Correspondence to Tom Hiatt (e-mail: hiattt@wpro.who.int).

--------------------------------------------------------

To cite this article: 



--------------------------------------------------------

Abstract 
--------------------------------------------------------
```{r abstract, echo=FALSE}
a1 <- signif((subset(esta, year==2000, e_prev_num) - subset(esta, year==yr, e_prev_num)) / subset(esta, year==2000, e_prev_num) * 100, 2)
a2 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(cases=sum0(c_notified / 1e6)) %>% signif(2)
a3 <- tb %>% filter(year==yr-1, g_whoregion=="WPR", c_newrel_tsr >= 85) %>% nrow()
a4 <- esta %>% filter(year==yr) %>% select(e_mort_exc_tbhiv_num, e_inc_num) %>% signif(2)

```

### Introduction
Since the year 2000, tuberculosis (TB) prevalence in the World Health Organization (WHO) Western Pacific Region decreased `r a1` percent. The current TB burden remains immense, however with `r a4[2]/1e6` million cases and `r a4[1]/1e3` thousand deaths every year. This study describes a regional analysis using data from the WHO global TB database incorporating TB notification data for `r yr`. 

### Methods
TB surveillance data are collected annually from countries and areas in the Region (n=36). TB case notifications, treatment outcomes and information on TB/HIV co-infection are covered in this analysis. For 2013, 32 countries and areas of the Western Pacific Region reported data representing more than 99.9% of the total population.

### Results
Countries and areas in the Region notified  `r a2` million new and relapse TB cases in `r yr`. The trend of the case notification rate saw an increase in the early 2000s, stabilized for several years and is in decline recently for all forms and bacteriologically confirmed cases. Country TB case rates for 2013 broken down by age and sex show generally higher rates with increased age and declining rates over time for all age groups. Treatment success remains high in the Region with `r a3` countries reaching or maintaining an 85% success rate. HIV testing among TB patients has increased gradually with approximately 11 000 HIV-positive TB patients found each year since 2009.

### Discussion
Notification rates suggest that true TB incidence is possibly declining while programme efforts for early case-finding, including clinically diagnosed cases, are increasing. Treatment success has remained high for six of seven high-burden countries in the Region. If patients are put on treatment early, this high level of success will help drive incidence downward. An estimated 32 000 (range: 29 000--36 000) people living with HIV develop TB every year in the Region, the majority of which remain undetected.

TB surveillance data is an important source of programmatic and epidemiological information within inherent limitations. Careful interpretation of these findings can provide useful insight for programmatic decision-making. While the TB burden remains immense, national TB programmes must evolve and adapt to build upon these gains.

--------------------------------------------------------

Introduction
--------------------------------------------------------
```{r intro, echo=FALSE}
i1 <- signif(subset(esta, year==2000, e_prev_num) / 1e6, 2)
i2 <- signif(subset(esta, year==yr, e_prev_num) / 1e6, 2)
i2a <- signif(sum0(subset(tb, g_whoregion=="WPR" & year >= 2000, c_newinc)) / 1e6, 3)
i3 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(cases=sum0(c_notified / 1e6)) %>% signif(2)

```

The burden of tuberculosis (TB) in the World Health Organization (WHO) Western Pacific Region has been greatly reduced with increased decline since 2000. Estimated TB prevalence fell from `r i1` million cases in 2000 to `r i2` million in `r yr`.[@WorldHealthOrganization2014] During the same period, `r i2a` million patients were diagnosed and treated. However, with TB programmes reporting `r i3` million TB cases annually and disease transmission high in several countries, national TB control programmes must continue to evolve and take advantage of new tools in order to further combat the epidemic. Under the new End TB Strategy with ambitous targets,[@WorldHealthOrganization2014a] effective monitoring and evaluation is needed to track progress and understand how to best adapt interventions. Surveillance data analysis provides valuable information on the current epidemiological situation, programmatic progress and future directions.

This article presents an updated regional analysis of TB notification data which provides updated information for our previous study.[@Hiatt2014] It describes the epidemiological situation and progress in programmatic response with particular focus on seven countries with a high burden of TB: Cambodia, China, the Lao People’s Democratic Republic, Mongolia, Papua New Guinea, the Philippines and Viet Nam. 

Methods
--------------------------------------------------------
```{r methods, echo=FALSE}
m1 <- tb %>% filter(year==yr, g_whoregion=="WPR", !is.na(c_newinc)) %>% nrow()
m2 <- floor(tb %>% filter(year==yr, g_whoregion=="WPR", !is.na(c_newinc)) %>% summarize(pop=sum(e_pop_num)) / tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(pop=sum(e_pop_num)) * 100 / 0.1) * 0.1 # rounding to increment
m3 <- tb %>% filter(year %in% 2008:2012, g_whoregion=="WPR") %>% mutate(nd=new_su / c_newinc * 100) %>% group_by(country) %>% summarize(ndo=round(max(nd),0)) %>% arrange(desc(ndo)) %>% head(3) %>% as.data.frame() 
m4 <- paste(paste(m3[1:(nrow(m3)-1),"country"], collapse=", "), m3[nrow(m3),"country"], sep=" and ")
m5 <- paste(paste(m3[1:(nrow(m3)-1),"ndo"], collapse=", "), m3[nrow(m3),"ndo"], sep=" and ")
m6 <- tb %>% filter(year %in% 2008:2012, g_whoregion=="WPR") %>% group_by(year) %>% summarize(nd=signif(sum0(new_su) / sum0(c_newinc) * 100,2)) %>% arrange(desc(nd)) %>% head(1) %>% select(nd) 


info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

### Data
Around March of each year, TB surveillance data are collected from countries and areas in the Region (n=36) using a web-based data collection form. Collected data covers the following areas: TB case notifications and treatment outcomes, diagnostic and treatment services, drug management, surveillance and surveys of drug-resistance, information on TB/HIV co-infection, infection control, engagement of all care providers and budgets and expenditures for TB control. The full description of methods is available in the Global Tuberculosis Report[@WorldHealthOrganization2014] and the data sets are available from the WHO global TB database.[@WorldHealthOrganization] This analysis only covers case notifications, treatment outcomes and TB/HIV co-infection data.

Case definitions for TB were revised in 2013[@WorldHealthOrganization2013] and cases previously known as smear-positive are now included in the category of bacteriologically confirmed cases which includes cases confirmed by any laboratory method. Similarly, smear-negative cases are combined with all clinically diagnosed cases including where smear was not done or results are unknown. This obscures the number of cases where laboratory confirmation was sought by including them with the number of cases for which confirmation was not attempted. Knowing this information can indicate uncertainty around the number of notified cases. 

For `r yr`, `r m1` countries and areas of the Western Pacific Region reported data representing more than `r m2`% of the total population. 

### Analysis and reproducibility
All analysis was conducted by the statistical software environment R (ver. `r r_ver`, R Core Team, `r info$R.version$year`, Vienna, Austria, www.R-project.org). 


Results
--------------------------------------------------------


### Case notification

```{r t-notif-data, warning=FALSE}
tableCount <- incCount(tableCount, "t-notif")

# Notification table

tbb <- subset(tb, year==yr & g_whoregion=="WPR", select=c('country', 'g_whoregion', 'g_hbc22', 'c_notified', 'c_newinc', "new_labconf", "new_clindx", "new_ep", "ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep", "ret_nrel"))

tbb <- tbb[order(tbb$country),]
names(tbb)[names(tbb)=='country'] <- 'area'

# make aggregate rows
tbbr <- aggregate(tbb[4:ncol(tbb)], by=list(area=tbb$g_whoregion), FUN=sum, na.rm=TRUE)

# combine together
tbc <- rbind(tbb[c(1, 4:ncol(tbb))], tbbr) # tbbh, , tbbga

# calculate and format vars

tbc$nrpulm_lab_pct <- .rowsums(tbc[c("new_labconf", "ret_rel_labconf")] )* 100 / .rowsums(tbc[c("new_labconf", "new_clindx", "ret_rel_labconf", "ret_rel_clindx")])

for(var in 2:ncol(tbc)){
  tbc[var] <- rounder(tbc[[var]])
  }

tbc[is.na(tbc$nrpulm_lab_pct), 'nrpulm_lab_pct'] <- "\u2013"

# rename
tbc <- .WPSARnames(tbc, col='area')

# Add to file

tbm <- xtable(tbc[c("area", "c_notified", 'c_newinc', "ret_nrel", "new_labconf", "new_clindx", "new_ep", "ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep", "nrpulm_lab_pct")])

digits(tbm) <- 0

write.csv(tbm, file=paste0(pasteLabel("./figure_data/table", tableCount, "t-notif", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE, na="")

# for paragraph
n1 <- tbc[nrow(tbc),"c_notified"]
n2 <- signif(tbbr$c_notified / sum(subset(tb, year==yr, c_notified), na.rm=TRUE) * 100, 2)
n3 <- signif(tbbr$c_newinc / tbbr$c_notified * 100, 3)
n4 <- tbc[nrow(tbc),"c_newinc"]
n5 <- signif(tbb[tbb$area == "China","c_notified"] / tbbr$c_notified * 100, 2)
n6 <- tbc[tbc$area == "China","c_notified"]
n7 <- signif(tbb[tbb$area == "Philippines","c_notified"] / tbbr$c_notified * 100, 2)
n8 <- tbc[tbc$area == "Philippines","c_notified"]
n9 <- signif(tbb[tbb$area == "Viet Nam","c_notified"] / tbbr$c_notified * 100, 2)
n10 <- tbc[tbc$area == "Viet Nam","c_notified"]

```

```{r m-notif-data, include=FALSE}

figCount <- incCount(figCount, "m-notif")

mc <- subset(tb, year==yr & g_whoregion=="WPR", select=c(country, iso2, iso3, g_whoregion, c_newinc, e_pop_num))

mc$c_newinc_100k <- mc$c_newinc / mc$e_pop_num *1e5

mc$cat <- cut(round(mc$c_newinc_100k,0), c(0, 10, 50, 100, 200, Inf), c('0–9', '10–49', '50–99', '100–199', '\u2265 200'), right=FALSE)

mc1 <- WHOmap.print(mc, legend.title= "TB cases per \n100 000 population", copyright=FALSE, show=FALSE, zoom="WPR")

write.csv(mc, file=paste0(pasteLabel("./figure_data/figure", figCount, "m-notif", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

ggsave(mc1, file=paste0(pasteLabel("./figure/figure", figCount, "m-notif", insLink=FALSE, sepper=""), ".pdf"))

# for paragraph
n11 <- mc %>% filter(cat=="\u2265 200") %>% arrange(desc(c_newinc_100k)) %>% .WPSARnames(the=TRUE) %>% mutate(c=country, r=signif(c_newinc_100k,3)) %>% select(c,r) 
n12 <- paste(paste(n11[1:(nrow(n11)-1),"c"], collapse=", "), n11[nrow(n11),"c"], sep=" and ")
n13 <- paste(paste(n11[1:(nrow(n11)-1),"r"], collapse=", "), n11[nrow(n11),"r"], sep=" and ")

```


In `r yr`, countries and areas in the Western Pacific Region (n=36) reported `r n1` people with TB disease (`r I(pasteLabel("Table", tableCount, "t-notif"))`), making up `r n2`% of the global burden. Of these, `r n3`% (`r n4` cases) were new episodes of TB disease (either new or relapse cases). Within the Region, China accounts for `r n5`% (`r n6` cases) of the caseload followed by the Philippines and Viet Nam with `r n7`% (`r n8` cases) and `r n9`% (`r n10` cases), respectively. TB notification rates, expressed as cases per 100 000 population in `r yr`, vary substantially in the Region with the highest rates (`r "\u2265"` 200 per 100 000 population in `r yr`) found in `r n12`  with `r n13` per 100 000 population in `r yr`, respectively (`r I(pasteLabel("Figure", figCount, "m-notif"))`). 

--------------------------------------------------------

<a id="t-notif"></a> 
**`r I(pasteLabel("Table", tableCount, "t-notif", insLink=FALSE))`. Tuberculosis case notifications from countries and areas of the Western Pacific Region, `r yr`**  
```{r t-notif, results='asis'}

print(tbm, type="html", include.rownames=F, include.colnames=F, html.table.attributes="border=0 rules=rows width=900 cellpadding=5", add.to.row=list(pos=list(0, nrow(tbm)), command=c(
  "<TR> 
  <TD colspan='4' style='border-right: solid 1px black;'></TD> 
  <TH colspan='3' style='border-right: solid 1px black;'>NEW OR PREVIOUS TREATMENT HISTORY UNKNOWN</TH> 
  <TH colspan='3' style='border-right: solid 1px black;'>RELAPSE</TH> 
  <TD></TD> 
  </TR> 
  <TR> 
  <TD></TD> 
  <TD>TOTAL NOTIFIED</TD> 
  <TD>NEW AND RELAPSE <sup>*</sup></TD> 
  <TD style='border-right: solid 1px black;'>RETREATMENT EXCLUDING RELAPSE</TD> 
  <TD>PULMONARY BACTERIOLOGICALLY CONFIRMED</TD>
  <TD>PULMONARY CLINICALLY DIAGNOSED</TD> 
  <TD style='border-right: solid 1px black;'>EXTRAPULMONARY</TD> 
  <TD>PULMONARY BACTERIOLOGICALLY CONFIRMED</TD>
  <TD>PULMONARY CLINICALLY DIAGNOSED</TD> 
  <TD style='border-right: solid 1px black;'>EXTRAPULMONARY</TD> 
  <TD>PERCENTAGE OF PULMONARY CASES BACTERIOLOGICALLY CONFIRMED</TD> 
  </TR> 
  <TR>", 
  "<TR> <TD colspan=11>Blank cells indicate data not reported.<br>
  <sup>*</sup> NEW AND RELAPSE includes cases for which the treatment history is unknown.</TD></TR>")))

```  


--------------------------------------------------------

<a id="m-notif"></a> 
**`r I(pasteLabel("Figure", figCount, "m-notif", insLink=FALSE))` TB case notification rate (new and relapse^*^) per 100 000 population in countries and areas of the Western Pacific Region, `r yr`**  
```{r m-notif, fig.height=5}

mc1
```  

<font size="1">The boundaries shown and the designations used on this map do not imply the expression of any opinion whatsoever on the part of the World Health Organization concerning the legal status of any country, territory, city or area or of its authorities, or concerning the delimitation of its frontiers or boundaries. White lines on maps represent approximate border lines for which there may not yet be full agreement.</font>

^*^ New and Relapse TB cases includes cases for which the treatment history is unknown.

--------------------------------------------------------

```{r f-notif-trend-data}

figCount <- incCount(figCount, "f-notif-trend")

nota <- subset(tb, year %in% 2000:yr & g_whoregion=="WPR", c(year, c_newinc, new_sp, new_labconf, e_pop_num))

notb <- aggregate(nota[2:ncol(nota)], by=list(year=nota$year), FUN=sum, na.rm=TRUE)

notb$`All forms of TB` <- notb$c_newinc / notb$e_pop_num * 1e5
notb$`New bacteriologically confirmed` <- ifelse(notb$year < 2013, notb$new_sp / notb$e_pop_num * 1e5, notb$new_labconf / notb$e_pop_num * 1e5)
notc <- melt(notb[c("year", "New bacteriologically confirmed", "All forms of TB")], id=1)

write.csv(notc, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-notif-trend", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# for paragraph
n16a <- notc %>% filter(variable=="New bacteriologically confirmed", year %in% c(2005,yr)) %>% arrange(year) %>% select(year, value)
n16 <- abs(signif(a.rate(start=n16a[1,2], end=n16a[2,2], years=n16a[2,1]-n16a[1,1]) * 100, 2)) 

```

Between 2002 and 2005, case notification rates in the Region of all forms of TB increased from 47 to 74 cases per 100 000 population per year and have stabilized since then at 73--78 cases per 100 000 population per year. New bacteriologically confirmed cases peaked in 2005 at 39 cases per 100 000 population per year (up from 22 in 2002), and has declined continuously to `r yr` at an average rate of `r n16`% per year (`r I(pasteLabel("Figure", figCount, "f-notif-trend"))`). 

--------------------------------------------------------

<a id="f-notif-trend"></a> 
**`r I(pasteLabel("Figure", figCount, "f-notif-trend", insLink=FALSE))` Tuberculosis case notification rate (all forms and new bacteriologically confirmed^*^) per 100 000 population per year in the Western Pacific Region, `r min(notc$year)`--`r max(notc$year)`**  
```{r f-notif-trend, fig.height=5}

notc1 <- ggplot(notc, aes(year, value, color=variable, ymin=0)) + geom_line(size=1) + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_y_continuous("TB cases per 100 000 per year", breaks = pretty_breaks()) + theme(legend.position="none") + geom_text(data=subset(notc, year==max(notc$year)), aes(label=variable), hjust=1.1, vjust=3) + scale_color_brewer(type="qual", palette=6)

notc1

ggsave(notc1, file=paste0(pasteLabel("./figure/figure", figCount, "f-notif-trend", insLink=FALSE, sepper=""), ".pdf"))

```

^*^ All forms of TB includes new and relapse TB cases, pulmonary and extrapulmonary, bacteriologically confirmed or clinicially diagnosed. New bacteriologically confirmed includes pulmonary TB cases only. Both categories include cases that have unknown treatment history.

--------------------------------------------------------

### Distribution of TB notifications by age and sex


```{r agesex-data,  echo=FALSE}
figCount <- incCount(figCount, "f-agesex-bar")
figCount <- incCount(figCount, "f-agesex")

aga <- merge(subset(tb, year %in% 2000:yr, select=c("iso3", "country", "year", "g_whoregion", "g_hbc22", "newrel_m04", "newrel_m514", "newrel_m014", "newrel_m1524", "newrel_m2534", "newrel_m3544", "newrel_m4554", "newrel_m5564", "newrel_m65", "newrel_mu", "newrel_f04", "newrel_f514", "newrel_f014", "newrel_f1524",  "newrel_f2534", "newrel_f3544", "newrel_f4554", "newrel_f5564", "newrel_f65", "newrel_fu",
                                              "new_sp_m04", "new_sp_m514", "new_sp_m014", "new_sp_m1524", "new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", "new_sp_mu", "new_sp_f04", "new_sp_f514", "new_sp_f014", "new_sp_f1524",  "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65", "new_sp_fu",
                                              "new_sn_m04", "new_sn_m514", "new_sn_m014", "new_sn_m1524", "new_sn_m2534", "new_sn_m3544", "new_sn_m4554", "new_sn_m5564", "new_sn_m65", "new_sn_mu", "new_sn_f04", "new_sn_f514", "new_sn_f014", "new_sn_f1524",  "new_sn_f2534", "new_sn_f3544", "new_sn_f4554", "new_sn_f5564", "new_sn_f65", "new_sn_fu", 
                                              "new_ep_m04", "new_ep_m514", "new_ep_m014", "new_ep_m1524", "new_ep_m2534", "new_ep_m3544", "new_ep_m4554", "new_ep_m5564", "new_ep_m65", "new_ep_mu", "new_ep_f04", "new_ep_f514", "new_ep_f014", "new_ep_f1524",  "new_ep_f2534", "new_ep_f3544", "new_ep_f4554", "new_ep_f5564", "new_ep_f65", "new_ep_fu")), subset(p, select=c("iso3", "country", "year", "e_pop_m04", "e_pop_m514", "e_pop_m014", "e_pop_m1524", "e_pop_m2534", "e_pop_m3544", "e_pop_m4554", "e_pop_m5564", "e_pop_m65", "e_pop_f04", "e_pop_f514", "e_pop_f014", "e_pop_f1524", "e_pop_f2534", "e_pop_f3544", "e_pop_f4554", "e_pop_f5564", "e_pop_f65")))

# Aggregate for region
agb1 <- aggregate(aga[6:ncol(aga)], by=list(year=aga$year, area=aga$g_whoregion), FUN=sum, na.rm=TRUE)

agb1[c('iso3', 'g_hbc22')] <- NA
agb1$iso3 <- agb1$area
agb1$g_whoregion <- agb1$area
aga1 <- reshape::rename(aga,c('country'='area'))
agb <- rbind(aga1, agb1)

# Calculate rates

agc <- melt(agb, id=1:5)
# agc[c('new', 'type', 'group')] <- str_split_fixed(agc$variable, '_', n=3) # This takes me 25 seconds...it's the '_all' or '_fixed' that's the killer.
agc$type1 <- str_extract(agc$variable, 'newrel|pop|new_sp|new_sn|new_ep')
agc$age <- str_replace(agc$variable, "newrel_|e_pop_|new_sp_|new_sn_|new_ep_", "")
agc$sex <- str_replace(agc$age, '[u]|[0-9]+', "")
agc$age <- str_replace(agc$age, '[f]|[m]', "")

# aggregate all types for previous years
agc$type <- ifelse(agc$type1=="pop", "pop", "newrel")
agc$value <- as.numeric(agc$value) # avoid integer overflow
agd1 <- agc %>%
  group_by(iso3, area, year, g_whoregion, g_hbc22, type, age, sex) %>%
  summarise(value=sum0(value)) # %>%
agd <- cast(agd1, ...~type, value = "value")

agd$newrel_100k <- agd$newrel / agd$pop * 1e5

# Subset for WPRO
age <- subset(agd, (iso3 %in% whbc | area=="WPR") & age!="u" & !age %in% c("04", "514"))
age$sex <- factor(age$sex, levels=c("m", "f"), labels=c("Male", "Female"))
age$sh.name <- factor(age$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao People’s \nDemocratic Republic", "Mongolia", "Papua New Guinea", "Philippines", "Viet Nam", "WPR"))
age[is.na(age$sh.name), 'sh.name'] <- "WPR"
age$age <- factor(age$age, c("014", "1524", "2534", "3544", "4554", "5564", "65"), c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", "<=65")) # \u2265 65

write.csv(age, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-agesex-bar", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

write.csv(age, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-agesex", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# For paragraph
n15 <- age %>% group_by(area, sex) %>% summarize(newrel=sum0(newrel)) %>% spread(sex, newrel) %>% mutate(sr=Male/Female) %>% arrange(desc(sr)) %>% filter(sr %in% range(sr)|area=="WPR") %>% mutate(sr=signif(sr,2))
n17 <- age %>% filter(year==yr, age=="0–14") %>% group_by(area) %>% summarise(um=signif(mean(newrel_100k),2)) %>% arrange(um) %>% slice(1)
n18 <- age %>% filter(year==yr, age!="0–14") %>% group_by(area, sex) %>% summarise(low=min(newrel_100k), high=max(newrel_100k)) %>% mutate(diffr=signif(high/low,2)) %>% filter(!is.na(diffr)) %>% ungroup() %>% arrange(desc(diffr))
n18a <- n18 %>% filter(diffr==max(diffr))
n18b <- n18 %>% filter(diffr==min(diffr))
mf.ratio.wpr <- n15 %>% filter(area=="WPR") %>% select(sr)

```

`r I(pasteLabel("Figure", figCount, "f-agesex-bar"))` shows age group and sex-specific case notification rates of new bacteriologically confirmed cases for countries with a high burden of TB in the Region with available data in `r yr`. All countries follow a typical pattern for cross-sectional observations with increasing notification rates towards older populations with the exception of Mongolia. Children age 0--14 showed the lowest rates for each country with `r n17[1]` showing the lowest rates (unweighted mean of males and females is `r n17[2]` cases per 100 000 population per year). Amongst the population 15 years and older, the difference in rates by sex comparing the lowest and highest rates was lowest in `r paste(n18b$area, tolower(n18b$sex))` cases, where the highest rate was only `r n18b$diffr` times the lowest, to `r paste(n18a$area, tolower(n18a$sex))` cases, where the highest rate was `r n18a$diffr` times the lowest. 

In general, males are more affected than females with male-to-female TB ratios as high as `r n15$sr[1]` as seen in `r n15$area[1]` and as low as `r n15$sr[3]` as seen in `r n15$area[3]`. The overall male-to-female ratio in the Region is `r mf.ratio.wpr`.

--------------------------------------------------------

<a id="f-agesex-bar"></a> 
**`r I(pasteLabel("Figure", figCount, "f-agesex-bar", insLink=FALSE))` Age group- and sex-specific notification rates (per 100 000 population) of new and relapse TB cases in countries with a high-burden of TB in the Western Pacific Region, `r yr`^*^**  
``` {r f-agesex-bar, fig.height=10, warning=FALSE}

# Workaround for non-reporting countries (so it doesn't break the plot)

age2 <- subset(age, year==yr)
age2$newrel_100k <- ifelse(is.na(age2$newrel_100k), 0, age2$newrel_100k)
agereport <- age2 %>% group_by(sh.name) %>% summarise(var=sum(newrel_100k)) %>% filter(var>0) %>% select(sh.name)
age3 <- subset(age2, sh.name %in% agereport$sh.name)

p2 <- ggplot(age3, aes(age, newrel_100k, fill=sex)) + geom_bar(stat="identity", position="dodge") + facet_wrap(~sh.name, scales="free_y", ncol=2)   + theme_report() + scale_fill_brewer('Sex', type="qual", palette=6) + scale_x_discrete("Age group", labels=c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", "\u2265 65")) + theme(legend.position="bottom")

# p3 <- facetAdjust(p2 + scale_y_continuous("New and relapse cases per 100 000")) # facetAdjust doesn't seem to come through for some reason.
p3 <- p2 + scale_y_continuous("New and relapse cases per 100 000")

p3

ggsave(p3, file=paste0(pasteLabel("./figure/figure", figCount, "f-agesex-bar", insLink=FALSE, sepper=""), ".pdf"), height = 11)

```

^*^ Scale of the vertical axis is different for each country. Data from Papua New Guinea were not available.

--------------------------------------------------------

`r I(pasteLabel("Figure", figCount, "f-agesex"))` shows trends of notification rates of new bacteriologically confirmed cases of age- and sex-specific groups in the seven countries with a high-burden of TB from 2000 to `r yr`. Cambodia and Viet Nam demonstrate a declining trend for all age- and sex- groups, ordered youngest to eldest with distinct separation except for Viet Nam female cases wherein the three youngest age groups plateau while the elder age groups decline. Case rates in the Philippines trend toward convergence with rates increasing in younger age groups and decreasing in older age groups. The &ge;65 group in the Philippines has rates similar to that of the 45--54 age group. Rates in China differ by sex where male cases nearly maintain the order of youngest to eldest, while female cases aged 15--24 break the order and are more similar to the 55--64 rate. The trend in Mongolia and Papua New Guinea is less distinct and doesn't follow the youngest to eldest order.


--------------------------------------------------------

<a id="f-agesex"></a> 
**`r I(pasteLabel("Figure", figCount, "f-agesex", insLink=FALSE))` Trend of age- and sex-specific notification rates (per 100 000 population per year) of new and relapse^*^ tuberculosis cases in countries with a high-burden of TB in the Western Pacific Region, `r min(age$year)`--`r max(age$year)`**  
``` {r f-agesex, warning=FALSE, fig.height=10, fig.width=4}

age.iso <- data.frame(a=unique(age$iso3)[1:4], b=unique(age$iso3)[5:8]) 

for(bit in names(age.iso)){
  p1 <- age %>% filter(iso3 %in% age.iso[[bit]]) %>% ggplot(aes(year, newrel_100k, color=age)) + geom_line() + facet_grid(sh.name~sex, scales='free_y') + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_color_brewer("Age group", type="div", palette="RdYlBu") + guides(color = guide_legend(reverse = TRUE)) 
  
  assign(paste0("age.", bit), p1)
  
 ggsave(file=paste0(pasteLabel("./figure/figure", figCount, "f-agesex", insLink=FALSE, sepper=""), bit, ".pdf"), height=5, width=4)
 
}

                                                                

```

``` {r f-agesex-a, warning=FALSE, fig.height=10, fig.width=4}
age.a + scale_y_log10("New and relapse cases per 100 000 (log scale)")+ theme(legend.position="none")
```
``` {r f-agesex-b, warning=FALSE, fig.height=10, fig.width=5}
age.b + labs(y="")
```

^*^ Rates prior to 2013 include new cases only.

--------------------------------------------------------



### Treatment outcomes

```{r f-txout-line-data}

figCount <- incCount(figCount, "f-txout-line")

tra <- subset(tb, year %in% 2000:(yr-1) & g_whoregion=="WPR", select=c(iso3, year, new_sp_coh, new_sp_cur, new_sp_cmplt, new_sp_died, new_sp_fail, new_sp_def, newrel_coh, newrel_succ, newrel_died, newrel_fail, newrel_lost))

trb <- aggregate(tra[3:ncol(tra)], by=list(year=tra$year), FUN=sum, na.rm=TRUE)
trb$iso3 <- "WPR"

trc <- rbind(tra, trb)

trc$area <- factor(trc$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao People’s \nDemocratic Republic", "Mongolia", "Papua New Guinea", "Philippines", "Viet Nam", "WPR"))

trd <- trc %>% filter(!is.na(area)) %>% rowSumsNA2("succ", c("new_sp_cur", "new_sp_cmplt", "newrel_succ")) %>% rowSumsNA2("coh", c("new_sp_coh", "newrel_coh")) %>% mutate(success=succ/coh*100) %>% select(area, iso3, year, success) 

write.csv(trd, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-txout-line", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# for paragraph 

# This can be replaced when the new data file is here (~2015)
tb2 <- tb
if(is.null(head(tb2$c_tsr))) tb2$c_tsr <- NA

n30 <- tb2 %>% filter(year==yr-1, g_whoregion=="WPR") %>% .WPSARnames(the=TRUE) %>% mutate(tsr=ifelse(!is.na(c_tsr), c_tsr, ifelse(!is.na(c_newrel_tsr), c_newrel_tsr, c_new_tsr))) %>% arrange(desc(tsr)) %>% select(country, iso3, tsr, newrel_coh, newrel_succ, newrel_fail, newrel_died, newrel_lost) %>% filter(tsr>0)
n31 <- n30 %>% filter(tsr >=85) %>% nrow()
n32 <- n30 %>% filter(iso3 %in% whbc) %>% mutate(tsr=signif(tsr,2))
n33 <- n32 %>% filter(tsr==last(tsr)) %>% mutate(neval=newrel_coh - sum(newrel_succ, newrel_fail, newrel_died, newrel_lost), l=signif(sum(newrel_lost, neval) / newrel_coh * 100, 2)) %>% select(l) %>% mutate(l=ifelse(l %in% 23:25, "approximately a quarter", ifelse(l %in% 25:29, "over a quarter", paste0(l, "%"))))
n34a <- tb %>% mutate(idefn=c_newinc-newrel_coh, idef=signif(idefn/c_newinc * 100, 2)) %>% filter(year==yr-1, iso3 %in% whbc, idef > 2) %>% select(country, idefn, idef, newrel_coh, newrel_succ) %>% mutate(tsrwidef=signif(newrel_succ/(newrel_coh + idefn)*100, 2)) %>% arrange(desc(idef))
n34 <- n34a %>% select(country, idef)
n35 <- numbers2words(nrow(n34))
n35c <- paste(paste(n34[1:(nrow(n34)-1),"country"], collapse=", "), n34[nrow(n34),"country"], sep=" and ")
n35n <- paste(paste(n34[1:(nrow(n34)-1),"idef"], collapse=", "), n34[nrow(n34),"idef"], sep=" and ")

```

Overall speaking, TB treatment success in the Region continues to be over 85% (`r I(pasteLabel("Figure", figCount, "f-txout-line"))`), a trend observed since  1997. Across the Region, `r n31` countries and areas reached or maintained 85% treatment success. Among the countries with a high burden of TB, treatment success was highest in `r n32[1,1]` (`r n32[1,3]`%) followed by `r n32[2,1]` (`r n32[2,3]`%), `r n32[3,1]` (`r n32[3,3]`%), `r n32[4,1]` (`r n32[4,3]`%), `r n32[5,1]` (`r n32[5,3]`%) and `r n32[6,1]` (`r n32[6,3]`%). The treatment success rate of `r n32[7,1]` was the lowest at `r n32[7,3]`% with `r n33` of the `r yr-1` cohort either lost to follow-up or un-evaluated. The proportion of `r yr-1` notified cases that were not reported as being put on treatment was highest in `r n35c` with `r n35n` percent, respectively. 

--------------------------------------------------------

<a id="f-txout-line"></a> 
**`r I(pasteLabel("Figure", figCount, "f-txout-line", insLink=FALSE))` Trend of TB treatment success among new bacteriologically confirmed cases in countries with a high-burden of TB of the Western Pacific Region, `r min(trd$year)`--`r max(trd$year)`**  
``` {r f-txout-line, fig.height=7.5}

trd1 <- ggplot(trd, aes(year, success, color=iso3, size = area=="WPR")) + geom_line() + theme_report() + geom_text(data=end.labels(trd, "year", "success", min.spread=1.4, max1=96), aes(label=iso3), hjust=-0.2, vjust=0, size=4)  + scale_y_continuous("Percent of cohort successfully treated") + scale_x_continuous("", limits=c(2000,yr-0.3)) + coord_cartesian(ylim=c(30,100)) + scale_size_discrete(range = c(1,1.5)) + theme(legend.position="none") + scale_color_brewer(type="qual", palette=6)  + guides(fill = guide_legend(reverse = TRUE))

trd1

ggsave(trd1, file=paste0(pasteLabel("./figure/figure", figCount, "f-txout-line", insLink=FALSE, sepper=""), ".pdf"))

# , breaks=min(trc$year):max(trc$year)

```

CHN=China; KHM=Cambodia; LAO=Lao People’s Democratic Republic; MNG=Mongolia; PNG=Papua New Guinea; PHL=Philippines; VNM=Viet Nam; WPR=Western Pacific Region

--------------------------------------------------------

### TB/HIV co-infection and collaborative activities

```{r f-tbhiv-data}

figCount <- incCount(figCount, "f-tbhiv")

tha1 <- subset(tb, year %in% 2006:yr & g_whoregion=="WPR" & iso3 %in% whbc, select=c("country", "year", "iso3", "g_hbc22", "c_notified", "hivtest", "hivtest_pos", "hiv_cpt", "hiv_art", "hivtest_pct_numerator", "hivtest_pct_denominator", "hivtest_pos_pct_numerator", "hivtest_pos_pct_denominator", "hiv_cpt_pct_numerator", "hiv_cpt_pct_denominator", "hiv_art_pct_numerator", "hiv_art_pct_denominator"))

# Clean this number for Mongolia
tha1[tha1$iso3=="MNG" & tha1$year==2006 & tha1$hivtest_pos_pct_numerator==1, "hivtest_pos_pct_numerator"] <- NA

tha2 <- aggregate(tha1[5:ncol(tha1)], by=list(year=tha1$year), FUN=sum, na.rm=TRUE)
tha2[c("country", "iso3")] <- "WPR"
tha2[c("g_hbc22")] <- NA
tha <- rbind(tha1, tha2)

tha$test <- tha$hivtest_pct_numerator / tha$hivtest_pct_denominator * 100
tha$pos <- tha$hivtest_pos_pct_numerator / tha$hivtest_pos_pct_denominator * 100
tha$cpt <- tha$hiv_cpt_pct_numerator / tha$hiv_cpt_pct_denominator * 100
tha$art <- tha$hiv_art_pct_numerator / tha$hiv_art_pct_denominator * 100

thb <- melt(tha[c("iso3", "year", "test", "pos", "cpt", "art")], id=1:2)

thb$variable <- factor(thb$variable, levels=c("test", "pos", "cpt", "art"), labels=c("HIV testing \namong TB patients", "HIV-positive among \nTB patients tested", "CPT coverage \namong co-infected", "ART coverage \namong co-infected"))

thb$country <- factor(thb$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao \nPeople’s \nDemocratic \nRepublic", "Mongolia", "Papua \nNew \nGuinea", "Philippines", "Viet Nam", "Western \nPacific \nRegion"))

write.csv(thb, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-tbhiv", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# For paragraph
thc <- tha %>% filter(iso3=="WPR", year==yr)
hivtest.pct.wpr <- thc %>% transmute(x=signif(test,2))
tbhiv.pct.wpr <- thc %>% transmute(x=signif(pos,2))
tbhiv.num.wpr <- thc %>% transmute(x=rounder(hivtest_pos_pct_numerator))
thd <- tha %>% filter(iso3=="WPR", year > 2009) %>% select(cpt) %>% signif(2) %>% range()
cpt.pct.range.wpr <- paste0(thd[1], "% and ", thd[2], "%")
art.pct.wpr <- thc %>% transmute(x=signif(art,2))
tbhiv.num.mng.max <- tha %>% filter(iso3=="MNG") %>% transmute(x=hivtest_pos_pct_numerator) %>% filter(x==max(x, na.rm=TRUE)) %>% mutate(x=numbers2words(x))
test.pct.phl <- tha %>% filter(iso3=="PHL", year==yr) %>% transmute(x=signif(test,2))
tbhiv.pct.phl <- tha %>% filter(iso3=="PHL", year==yr) %>% transmute(x=signif(pos,2))
test.pct.png <- tha %>% filter(iso3=="PNG", year==yr) %>% transmute(x=signif(test,2))
tbhiv.pct.png <- tha %>% filter(iso3=="PNG", year==yr) %>% transmute(x=signif(pos,2))

```

`r I(pasteLabel("Figure", figCount, "f-tbhiv"))` summarizes four basic indicators (HIV testing, HIV positivity rate, co-trimoxazole preventive therapy (CPT) coverage and  antiretroviral therapy (ART) coverage) for the seven countries with a high burden of TB. Overall in the Region HIV testing has steadily increased to `r hivtest.pct.wpr`% in `r yr`. Alongside this increase in testing the proportion of TB/HIV cases found has steadily declined over the same period to `r tbhiv.pct.wpr`% in `r yr` equivalent to `r tbhiv.num.wpr` cases. CPT coverage increased from 2007 to 2009 and has since leveled off ranging between `r cpt.pct.range.wpr` and possibly declining in `r yr`. ART coverage has also increased reaching the highest point in `r yr` at `r art.pct.wpr`%.

Cambodia and Viet Nam reported the most comprehensive data completeness and programmatic progress. The coverage of HIV testing, CPT and ART progressively increased, with a steady decrease in the proportion of HIV positive individuals among TB patients. Mongolia also reported a high level of testing with no more than `r tbhiv.num.mng.max` cases per year found positive since 2006. HIV testing is the lowest in the Philippines at `r test.pct.phl`% in `r yr` detecting the second lowest proportion of cases (after Mongolia) at `r tbhiv.pct.phl`%. The next lowest proportion tested is Papua New Guinea at `r test.pct.png`%, but with the highest proportion found positive at `r tbhiv.pct.png`%. 

--------------------------------------------------------

<a id="f-tbhiv"></a> 
**`r I(pasteLabel("Figure", figCount, "f-tbhiv", insLink=FALSE))` Progress in TB/HIV activities in countries with a high burden of TB in the Western Pacific Region, `r min(thb$year)`--`r max(thb$year)`**  
``` {r f-tbhiv, fig.width=8, fig.height=9, warning=FALSE}

thb1 <- ggplot(thb, aes(year, value)) + geom_line(size=1) + facet_grid(country~variable) + theme_report() + labs(y="Percent", x="")

thb1

ggsave(thb1, file=paste0(pasteLabel("./figure/figure", figCount, "f-tbhiv", insLink=FALSE, sepper=""), ".pdf"), height=9)

```

--------------------------------------------------------


Discussion
--------------------------------------------------------

```{r f-est-data, include=FALSE}

figCount <- incCount(figCount, "f-est")

eget <- c("year", "e_pop_num", "e_inc_100k", "e_inc_100k_lo", "e_inc_100k_hi", "e_prev_100k", "e_prev_100k_lo", "e_prev_100k_hi", "e_mort_exc_tbhiv_100k", "e_mort_exc_tbhiv_100k_lo", "e_mort_exc_tbhiv_100k_hi")

# esta <- subset(estimates, year >=1990 & group_name=="WPR", select=eget)
estb <- tb[tb$year %in% 1990:yr & tb$g_whoregion=="WPR", c("year", "c_newinc")]
estc <- aggregate(estb["c_newinc"], by=list(year=estb$year), FUN=sum, na.rm=TRUE)

estd <- merge(esta, estc)

estd$c_newinc_100k <- estd$c_newinc / estd$e_pop_num * 1e5

estf <- NULL
for(var in c("inc", "prev", "mort_exc_tbhiv")){
  df <- subset(estd, select=c("year", paste0("e_", var, "_100k"), paste0("e_", var, "_100k_lo"), paste0("e_", var, "_100k_hi")))
  names(df) <- c("year", "best", "lo", "hi")
  df$var <- var
  estf <- rbind(estf, df)
  }

estg <- estd[c("year", "c_newinc_100k")]
estg$var <- "inc"

esth <- merge(estf, estg, all.x=TRUE)
esth$var <- factor(esth$var, levels=c("inc", "prev", "mort_exc_tbhiv"), labels=c("Incidence and notification", "Prevalence", "Mortality (excluding HIV)"))

write.csv(esth, file=paste0(pasteLabel("./figure_data/figure", figCount, "f-est", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# for paragraph
d1 <- estd %>% filter(year==yr) %>% mutate(c=signif(c_newinc / 1e6, 2), r=signif(c_newinc_100k,2)) %>% select(c, r)
d2 <- estd %>% filter(year==yr) %>% select(e_inc_tbhiv_num, e_inc_tbhiv_num_lo, e_inc_tbhiv_num_hi) %>% signif(2) %>% rounder() 
d3 <- notc %>% filter(variable=="New bacteriologically confirmed", year %in% c(2005,2010,yr)) %>% arrange(year) %>% select(year, value)
new.labconf.ar <- abs(signif(a.rate(start=d3[1,2], end=d3[2,2], years=d3[2,1]-d3[1,1]) * 100, 2)) 
new.labconf.ar[2] <- abs(signif(a.rate(start=d3[2,2], end=d3[3,2], years=d3[3,1]-d3[2,1]) * 100, 2)) 
labconf.diff <- notc %>% filter(year %in% c(2005,yr)) %>% arrange(year) %>% select(year, variable, value) %>% spread(variable, value) %>% transmute(year, x=signif(`New bacteriologically confirmed` / `All forms of TB` * 100, 2))

  
```


In `r yr`, `r d1$c` million new and relapse TB cases (all forms) were notified from countries and areas of the Western Pacific Region which equals a rate of `r d1$r` per 100 000 population. This level has held steady for the past several years (`r I(pasteLabel("Figure", figCount, "f-notif-trend"))`). In contrast to the rate of all forms of TB, the rate of new bacteriologically confirmed cases gradually declined at `r new.labconf.ar[1]`% from 2005 to 2010 and accelerated to `r new.labconf.ar[2]`% until `r yr`. The difference in these trends suggests that true TB incidence is possibly declining while programme efforts for early case-finding, including clinically diagnosed cases, are increasing. Increased case-finding efforts can result in a lower proportion of cases with bacteriological confirmation as some cases are found before the bacterial load increases to a detectable level.[@WorldHealthOrganisation2013] The proportion of cases bacteriologically confirmed decreased from `r labconf.diff[1,2]`% in `r labconf.diff[1,1]` to `r labconf.diff[2,2]`% in `r labconf.diff[2,1]`. 

Two changes in the recording and reporting framework influence the last data point in this trend of bacteriologically confirmed cases. First, the trend-line previous to 2013 only included smear microscopy as a method of laboratory confirmation. Starting in 2013 any form of laboratory confirmation is included in this indicator including more sensitive diagnostics. This expansion of criteria may be responsible for the slight increase for 2013. Second, previous to 2013 clinically diagnosed cases were disaggregated by smear-negative and smear unknown or not done. This gave some information around the certainty of the cases diagnosed. From 2013, this disaggregation is no longer included in annual reporting, so it is unknown what proportion of non-bacteriologically confirmed cases were simply due to the laboratory test not being attempted. Between 2008 and 2012 at the regional level this proportion was small, a maximum of `r m6`% of cases did not have a smear result in any given year. However at the country level, the proportion was as high as `r m5` percent  in `r m4`, respectively. 

The changes in the recording and reporting framework also affect notification data disaggregated by age and sex. Prior to 2013, notifications by age and sex were further disaggregated by site of the disease (pulmonary or extrapulmonary) and by smear status (smear-positive and smear-negative/unknown/not done) for pulmonary cases. These data were only collected for new patients. Since the introduction of the revised recording and reporting framework, this further disaggregation was discontinued in favour of one age and sex table with relapse cases included. Besides restriction on more granular analysis, this also affects the time trend of notifications, since relapse cases are now included, and also increases uncertainty around diagnosed cases since clinically-diagnosed cases may not be actual TB cases.

TB control under stable conditions frequently results in case rates that increase with age as individuals both have more time to be exposed to the disease and more time for the disease to develop.[@Rieder1999] Most countries in `r I(pasteLabel("Figure", figCount, "f-agesex-bar"))` follow this pattern. Slight departures from this patter may be attributed to inaccuracies in population estimates, however the pattern in Mongolia shows rates for the population groups age 15--34 much higher than expected and warrants further investigation. The male to female ratio varies substantially in the region and despite efforts to understand the role gender plays in TB epidemiology,[@Uplekar; @Thorson2001] much is still unknown. The reason for these differences is likely a combination of biological and social factors.[@Borgdorff2000]

In situations where the demographic composition, specifically age and sex, is changing over time, the crude notification rate may not present a clear picture of epidemiological trends. TB rates may be decreasing in all age groups, but if the mean age of the population is increasing, moving a larger proportion of the population into older age groups where TB rates are highest, the crude trend may show no decline or even an increase. For this reason, examining age- and sex- specific case notification rates may provide more insight into the underlying epidemiology.

With the disaggregated view of notification in `r I(pasteLabel("Figure", figCount, "f-agesex"))`, it appears probable that incidence in Cambodia and Viet Nam is indeed declining. Both countries report the age and sex breakdown only for bacteriologically confirmed cases and the proportion of cases tested is continuously high. These reductions in rates in light of sustained programme performance would be difficult to explain otherwise. WHO global estimates and other studies have come to similar conclusions.[@Morishita2015; @Huong]

Treatment success has remained high for six of seven high-burden countries in the Region since 2005. In addition to patient benefit, if patients are put on treatment early, this high level of success will help drive incidence downward. The trend is erratic in the remaining high-burden country, Papua New Guinea, with a large proportion of cases not put on treatment and a large number of patients lost to follow-up or not evaluated. The number of cases not put on treatment is also a concern in Lao People's Democratic Republic and Cambodia although if these cases were included in the treatment cohort, treatment success would still be over 85%. 

An estimated `r d2[1]` (range: `r d2[2]`--`r d2[3]`) people living with HIV develop TB every year in the Region. While the HIV burden in the Region remains comparatively low, TB poses a dangerous threat and collaborative TB/HIV services are vital to save lives. Testing continues to increase gradually, although still below 50%. CPT coverage has levelled off and perhaps began to decline representing a possible risk for essential services. ART coverage is increasing, but still shows major gaps in most countries in the Region.

This report provides a snapshot of the epidemiological and programmatic situation of TB in the Western Pacific Region based on the case notification data in `r yr`. Many countries report case data broken down by age for bacteriologically confirmed cases only although WHO has been requesting this information since 2006.[@WorldHealthOrganization2006] This obscures the number of young children detected and poses a great limitation to the analysis of notifications by age and sex. Bacteriological confirmation is much rarer in young children due to difficulty in producing sputum. With the expanding coverage of central case-based recording and reporting systems, this data is becoming more available.

Analysis of surveillance data has inherent limitations. While the primary aim of TB surveillance is to provide insights into the TB situation in a specific population, undercapturing systems often reflect more the fluctuating performance of the TB control programme than the epidemiology of TB in the population. Systems meeting minimum standards of quality for their TB surveillance systems[@WorldHealthOrganization2014b] provide more robust estimates of disease burden and can be used as a proxy for TB incidence which has not yet been directly measured in any country. A careful assessment of programmatic progress and the quality of surveillance data for each country is needed when interpreting these findings.

TB surveillance continues to be an important source of information for assessing the TB situation and measuring progress to inform decision-making. WHO Regional Office for the Western Pacific will continue to conduct regional analyses on various topics related to TB epidemiology and programmatic progress, such as the situation of drug-resistant TB, subnational data analysis and utilization, TB in low- and intermediate-burden countries, contact investigation and other forms of TB screening activities to stimulate the utilization of surveillance data for informed programme decision-making. We also will continue to provide support to countries to conduct epidemiological and programmatic assessments at national and subnational levels.

--------------------------------------------------------

**<em>Supplementary materials</em>**

In response to calls for transparent and reproducible research,[@Peng2006; @Groves2012] we have published programme code to generate the entire contents of this article including all figures and tables by using R with the knitr package (ver. `r info$otherPkgs$knitr$Version`, Yihui Xie, `r format.Date(info$otherPkgs$knitr$Date, "%Y")`). Readers can download the code (available on request) and reproduce all figures and tables under an appropriate personal computing environment. For non-commercial purposes, readers may modify the code to produce figures and tables that are not presented in this article. For instance, readers may wish to produce tables and figures for countries or regions other than the WHO Western Pacific Region.

--------------------------------------------------------

**<em>Funding</em>**

None.

--------------------------------------------------------

**<em>Conflict of interest</em>**

None declared.

--------------------------------------------------------

**<em>Acknowledgement</em>**

The authors are very grateful to the national tuberculosis control programmes of the countries of the Western Pacific Region.

--------------------------------------------------------

**<em>References:</em>**

```{r, include=FALSE, echo=FALSE}
# Bit to copy html file over
# file.copy("D:/Users/hiattt/Dropbox/Code/Surveillance reports/RegTBfigsTables.html", "D:/Users/hiattt/Dropbox/STB-WPRO 2016/WPSAR articles/WPRupdate.html", overwrite = TRUE)
```
