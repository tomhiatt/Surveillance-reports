---
title: Epidemiological Situation of Tuberculosis in countries of the Western Pacific with a low or intermediate disease burden using `r yr <- 2013; yr` case notification data
author: "Tom Hiatt<sup>&dagger;</sup> and Nobuyuki Nishikiori<sup>&dagger;</sup>"
csl: vancouver-imperial-college-london.csl
output:
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: no
    theme: united
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    fig_height: 7
bibliography: WPRupdate.bib
---

```{r setup, echo=FALSE, include=FALSE}

################################################### 
# Tom Hiatt
# Updated: 30 April 2015
# Low Incidence countries analysis
###################################################

## Change this information to customize for your own data.

yr <- 2013

###################################################

# > sessionInfo()

# library(plyr) #Note: plyr must be loaded before dplyr
lapply(c("reshape", "dplyr", "ggplot2", "grid", "scales", "xtable", "stringr", "ggthemes", "tidyr", "directlabels", "proto"), library, character.only=TRUE)
# proto is automatically called by direct.label.

# Reproducible research process inspired by: http://gforge.se/2014/01/fast-track-publishing-using-knitr-part-ii/

# Global options for knitr
# change this to 'postscript' for EPS output.
require(knitr)
opts_chunk$set(
  #   dev="png",
  #   dev.args=list(type="cairo"),
  #   dpi=96,
  fig.width=7,
  echo=FALSE
  )

lic <- c("AUS", "BRN", "HKG", "JPN", "KOR", "MAC", "MYS", "NZL", "SGP")

# WPRO countries not included (HBC or Pacific)
# "ASM" "CHN" "COK" "FJI" "FSM" "GUM" "KHM" "KIR" "LAO" "MHL" "MNG" "MNP" "NCL" "NIU" "NRU"
# "PHL" "PLW" "PNG" "PYF" "SLB" "TKL" "TON" "TUV" "VNM" "VUT" "WLF" "WSM"

# Create regional report folder if needed.
# dir.create("./LowInc_report") # run this if error below
# dir.create("./figure_data") # run this if error below
if(!any(grep("LowInc_report", getwd()))) setwd("./LowInc_report")


# Theme for plots
theme_report <- function(base_size=12, base_family="") {
  colors <- ggthemes_data$few
  gray <- colors$medium['gray']
  black <- colors$dark['black'] # I don't know why these last 3 parts are needed, but they are. List is here: http://docs.ggplot2.org/0.9.2.1/theme.html
  theme_bw(base_size=base_size, base_family=base_family) +
    theme(
      line = element_line(colour = gray),
      rect = element_rect(fill = "white", colour = NA),
      text = element_text(colour = black),
      axis.ticks.x = element_line(colour = gray),
      axis.ticks.y = element_blank(),
      legend.key = element_rect(colour = NA),
      ## Examples do not use grid lines
      panel.border = element_rect(colour = gray),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      strip.background = element_rect(fill="white", colour=NA),
      strip.text = element_text(hjust=0)
      )
  }

########################################################
# Functions for data formatting and manipulation
########################################################

# Simple rounder that just adds in the thousands separator 
rounder <- function(x, decimals=FALSE, thousep=" ") {
  if(decimals==TRUE){
    ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 0.01, "<0.01", ifelse(round(x,2) < 0.1, formatC(round(x,2), format='f', digits=2), ifelse(round(x,1) < 10, formatC(round(x,1), format='f', digits=1), formatC(round(x,0), big.mark=thousep, format='d') )))))
    }
  else ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 1, "< 1", formatC(round(x,0), big.mark=thousep, format='d'))))
  }

.rowsums <- function(x) { 
  # This function sums rows ignoring NAs unless all are NA
  # use it like this
  # t3c$snu <- .rowsums(t3c[c('new_sn', 'new_su')])
  tosum <- as.matrix(x)
  summed <- rowMeans((tosum), na.rm=T) * rowSums(!is.na((tosum)))
  return(summed)
  }

sum0 <- function(x) sum(x, na.rm = !all(is.na(x)))

# Change names to WPSAR convention
# .WPSARnames <- function(d, col='country', the=FALSE){
#   d[col] <- as.character(d[[col]])
#   d[col] <- ifelse(d[[col]]=='China, Hong Kong SAR', 'Hong Kong Special Administrative Region (China)', 
#                    ifelse(d[[col]]=='China, Macao SAR', 'Macao Special Administrative Region (China)', 
#                           ifelse(d[[col]]=='Micronesia (Federated States of)', 'Micronesia, Federated States of', 
#                                  ifelse(d[[col]]=='WPR', 'Western Pacific Region
#                                         ', d[[col]]))))
#   
#   if(the){
#     d[col] <- ifelse(d[[col]]=='Philippines', 'the Philippines',
#                      ifelse(d[[col]]=="Lao People's Democratic Republic", "the Lao People's Democratic Republic", d[[col]]))
#     }
#   
#   
#   return(d)
#   }

lister <- function(x, sep=","){
  if(length(x)==1) return(x)
  if(length(x)==2) return(paste(x, collapse=" and "))
  else return(paste(paste(x[1:(length(x)-1)], collapse=paste0(sep, " ")), x[length(x)], sep=" and "))
}

# For time series with dropped data points
orphaned.dots <- function(vect){
  if(length(vect) < 3) stop("Vector length must be at least 3.")
  
  vect1 <- ifelse(!is.na(vect[1]) & is.na(vect[2]), TRUE, FALSE)
  for(point in 2:(length(vect)-1)){
    vect1 <- c(vect1, ifelse(!is.na(vect[point]) & is.na(vect[point-1] & is.na(vect[point+1])), TRUE, FALSE)) 
  }
  vect1 <- c(vect1, ifelse(!is.na(vect[length(vect)]) & is.na(vect[length(vect)-1]), TRUE, FALSE))
  return(vect1)
}

########################################################
# Functions for maps
########################################################

# source("./MapFunctions.r")
# load("gparts.Rdata")

########################################################
# Functions to assist with tables and figure in markdown document (from here: http://rmflight.github.io/posts/2012/10/papersinRmd.html)
########################################################

incCount <- function(inObj, useName) {
  nObj <- length(inObj)
  useNum <- max(inObj) + 1
  inObj <- c(inObj, useNum)
  names(inObj)[nObj + 1] <- useName
  inObj
  }
figCount <- c(`_` = 0)
tableCount <- c(`_` = 0)

# tableCount

pasteLabel <- function(preText, inObj, objName, insLink = TRUE, sepper = " ") {
  objNum <- inObj[objName]
  
  useText <- paste(preText, objNum, sep = sepper)
  if (insLink) {
    useText <- paste("[", useText, "](#", objName, ")", sep = "")
  }
  useText
}

tableCat <- function(inFrame) {
  outText <- paste(names(inFrame), collapse = " | ")
  outText <- c(outText, paste(rep("---", ncol(inFrame)), collapse = " | "))
  invisible(apply(inFrame, 1, function(inRow) {
    outText <<- c(outText, paste(inRow, collapse = " | "))
    }))
  return(outText)
  }

# Create directory and Get data

if(!"data" %in% dir()){
  dir.create(paste("./data"))
  stop("Download the notification and treatment outcomes data from 'http://who.int/tb/country/data/download/en/' to './data'.")
  }

data1 <- dir("./data", full.names=TRUE)
tb <- NULL
for(i in data1){
  data3 <- read.csv(i)
  tb <- merge(tb, data3, all=TRUE)
  }

# Note: to use your own data, make a flat data file with each row corresponding to the lower reporting unit and a aggregating variable. EG by country with aggregating variable of region.

# Add needed variables
tb$g_hbc22 <- ifelse(tb$iso3 %in% c("AFG", "BGD", "BRA", "CHN", "COD", "ETH", "IDN", "IND", "KEN", "KHM", "MMR", "MOZ", "NGA", "PAK", "PHL", "RUS", "THA", "TZA", "UGA", "VNM", "ZAF", "ZWE"), "high", "low")

# pacific <- c("ASM", "COK", "FJI", "PYF", "GUM", "KIR", "MHL", "FSM", "NRU",   "NCL", "NIU", "MNP", "PLW", "WSM", "SLB", "TKL", "TON", "TUV", "VUT", "WLF")

# tb$g_wpr <- ifelse(tb$iso3 %in% lic, "High-burden", ifelse(tb$iso3 %in% pacific, "Pacific", "Other"))
# tb$g_wpr <- factor(tb$g_wpr, levels=c("High-burden", "Pacific", "Other", "WPR"))

# tb$c_new <- .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth")])
tb$c_newinc <- ifelse(tb$year < 2013, .rowsums(tb[c("tot_newrel", "newret_oth")]), .rowsums(tb[c("new_labconf", "new_clindx", "new_ep", "ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep")]))
tb$c_newunk <- ifelse(tb$year < 2013, .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth", "newret_oth")]), .rowsums(tb[c("new_labconf", "new_clindx", "new_ep")]))
# tb$c_ret <- .rowsums(tb[c("ret_rel", "ret_taf", "ret_tad", "ret_oth")])
tb$c_notified <- ifelse(tb$year < 2013, .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth", "ret_rel", "ret_taf", "ret_tad", "ret_oth", "newret_oth")]), .rowsums(tb[c("c_newinc", "ret_nrel")]))
tb$c_newrel_tsr <- tb$newrel_succ / tb$newrel_coh * 100

# replace e_pop_num with p version which has back to 1980
tb <- merge(tb[names(tb)[names(tb)!="e_pop_num"]], p[c("iso3", "year", "e_pop_num")]) # Hmmm, missing 4. I'm going to assume those are the countries with changed political boundaries not seen in WPR.

tb$c_newinc_100k <- tb$c_newinc / tb$e_pop_num * 1e5

# Get population data (available from UN population division. http://esa.un.org/unpd/wpp/unpp/panel_population.htm) and formatted TB/HIV data and estimates for the WHO Western Pacific Region.

if(FALSE){
  runprofile()
  esta <- subset(araw, group_name=="WPR", select=c("year", "e_pop_num", "e_inc_100k", "e_inc_100k_lo", "e_inc_100k_hi", "e_prev_100k", "e_prev_100k_lo", "e_prev_100k_hi", "e_mort_exc_tbhiv_100k", "e_mort_exc_tbhiv_100k_lo", "e_mort_exc_tbhiv_100k_hi", "e_prev_num", "e_prev_num_lo", "e_prev_num_hi"))
  tb2 <- subset(tb, select=c(iso3, year, notif_foreign))
  # Get GDP and migrant stock from world bank data
  require(WDI)
  
  gb <- WDI(indicator='NY.GDP.PCAP.KD', start=2000, end=2013, extra=FALSE)
  oba <- WDI(indicator='SM.POP.TOTL.ZS', start=1980, end=2013, extra=FALSE)
  
  save(esta, p, tbhiv, tb2, gb, oba, file="./laddata.Rdata")
}

load("./laddata.Rdata")

tb <- merge(tb, tbhiv[c(3,4,15:ncol(tbhiv))], all=TRUE)
tb <- merge(tb, tb2, all.x=TRUE)

tbl <- tb %>% filter(iso3 %in% lic) %>% arrange(country) 
  


# Questions this analysis is trying to answer
# How much TB still exists in WPR?
# Is the amount of TB going up, coming down, or staying stable?
# Where is TB clustering in the region?
# Is the clustering staying the same or changing, if changing how?
# where is the amount of TB coming down and at what rate? Is it going up anywhere?
# Are child cases being found? What about among women? How is the disease progressing with aging countries?
# What do we know about these populations and how is TB reflecting or being affected?
# Where is TB still spreading and where is it only reactivation? Where are chunks of the population likely not infected?
# What is the relationship between wealth (GDP) and TB motality at the national level? What are the macro associations (causes) for TB?
# What is the relationship between Migrant stock and TB?
# Which programmes are ahead of the game in finding cases?
# Which programmes treat the best? If you get TB, which country do you hope you live in?
# 
# Structure
# table of latest year
# map of latest year
# trend by group
# 
# HIGH BURDEN
# relationship between GDP and mort
# aging plot
# notif trend panel plot
# treatment success
# financing?
# HIV?
# 
# PACIFIC
# scatter of notif rate by abs num 
# MDR in the pacific
# 
# OTHER
# scatter of rate and abs num
# scatter of rate and migrant stock, maybe include foreign born var
# aging plot
  
# since revised, here's the structure for the LIC analysis
# Table with total cases, rates, % lab-confirmed, % pulmonary, % foreign
# raw trend of total cases with age-sex analysis. Maybe only age?
# GDP and case rates analysis
# Migrant and case rates analysis
# Treatment success
# TB/HIV

```

```{r t.notif.data, warning=FALSE}
tableCount <- incCount(tableCount, "t.notif")

# Notification table

tbb1 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% mutate(area=country, total="WPR") %>% select(area, total, c_notified, c_newinc, new_labconf, new_clindx, new_ep, ret_rel_labconf, ret_rel_clindx, ret_rel_ep, ret_nrel)

tbb <- tbl %>% filter(year==yr) %>% mutate(area=country, total="Total") %>% select(area, total, c_notified, c_newinc, new_labconf, new_clindx, new_ep, ret_rel_labconf, ret_rel_clindx, ret_rel_ep, ret_nrel)

# make aggregate rows
tbbr <- aggregate(tbb1[3:ncol(tbb1)], by=list(area=tbb1$total), FUN=sum, na.rm=TRUE)
tbbl <- aggregate(tbb[3:ncol(tbb)], by=list(area=tbb$total), FUN=sum, na.rm=TRUE)

# combine together
tbc <- rbind(tbb[c(1, 3:ncol(tbb))], tbbl, tbbr) # tbbh, , tbbga

# calculate and format vars

tbc$nrpulm_lab_pct <- paste0(rounder(.rowsums(tbc[c("new_labconf", "ret_rel_labconf")] )), 
                             " (", rounder(.rowsums(tbc[c("new_labconf", "ret_rel_labconf")] )* 100 / .rowsums(tbc[c("new_labconf", "new_clindx", "ret_rel_labconf", "ret_rel_clindx")]), decimals = TRUE), ")")

tbc$nr_ep_pct <- paste0(rounder(rowSumsNA(tbc[c("new_ep", "ret_rel_ep")])), 
                        " (", rounder(rowSumsNA(tbc[c("new_ep", "ret_rel_ep")]) / tbc$c_newinc * 100, decimals = TRUE), ")")

tbc$nr_rel_pct <- paste0(rounder(.rowsums(tbc[c("ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep")])), 
                         " (", rounder(.rowsums(tbc[c("ret_rel_labconf", "ret_rel_clindx", "ret_rel_ep")]) / tbc$c_newinc * 100, decimals = TRUE), ")")

tbc$notif_nrel_pct <- paste0(rounder(tbc$ret_nrel), 
                          " (", rounder( tbc$ret_nre  / tbc$c_notified * 100, decimals = TRUE), ")")



for(var in 2:3){
  tbc[var] <- rounder(tbc[[var]], decimals = TRUE)
  }

tbc[tbc$notif_nrel_pct=="NA (NA)", 'notif_nrel_pct'] <- ""

# How about changing ep to %. compare these areas with the regional average for. % ep, % relapse, % lab confirmed, 


# Add to file

tbm <- xtable(tbc[c("area", 'c_newinc', "nrpulm_lab_pct", "nr_ep_pct", "nr_rel_pct", "c_notified", "notif_nrel_pct")],  align = c("c", "l", rep("r",6)))

digits(tbm) <- 0

write.csv(tbm, file=paste0(pasteLabel("./figure_data/table", tableCount, "t.notif", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE, na="")

# for paragraph
n1 <- paste(round(tbbl$c_notified / 1e3, 0), "thousand")
n2 <- signif(tbbr$c_notified / sum(subset(tb, year==yr, c_notified), na.rm=TRUE) * 100, 2)
n3 <- signif(tbbr$c_newinc / tbbr$c_notified * 100, 3)
n4 <- tbc[nrow(tbc),"c_newinc"]
n5 <- signif(tbb[tbb$area == "China","c_notified"] / tbbr$c_notified * 100, 2)
n6 <- tbc[tbc$area == "China","c_notified"]
n7 <- signif(tbb[tbb$area == "Philippines","c_notified"] / tbbr$c_notified * 100, 2)
n8 <- tbc[tbc$area == "Philippines","c_notified"]
n9 <- signif(tbb[tbb$area == "Viet Nam","c_notified"] / tbbr$c_notified * 100, 2)
n10 <- tbc[tbc$area == "Viet Nam","c_notified"]

```

```{r f.spread.data, include=FALSE}
figCount <- incCount(figCount, "f.spread")

spa <- tbl %>% filter(year==yr) %>% select(c_newinc_100k, c_newinc, iso3, e_pop_num)

f.spread <- spa %>% ggplot(aes(c_newinc_100k, c_newinc, group=iso3, size=e_pop_num/1e6)) + geom_text(aes(label=iso3), size=4, hjust=-.3, vjust=-.5) + geom_point() + theme_report() + labs(x="New and relapse cases per 100 000 (log scale)", y="Total new and relapse cases", size="Population \n(millions)") + scale_x_log10(limits=c(5,100), breaks=c(5, 10, pretty(20:100)))

# tbl %>% filter(year==yr) %>% ggplot(aes(c_newinc_100k, c_newinc, group=iso3)) + geom_text(aes(label=iso3)) + theme_report() + theme(legend.position="none") + labs(x="New and relapse cases per 100 000", y="Total new and relapse cases") + xlim(c(0,100))

write.csv(spa, file=paste0(pasteLabel("./figure_data/table", figCount, "f.spread", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE, na="")

```

```{r f.trend.data, include=FALSE}
figCount <- incCount(figCount, "f.trend")

tra <- tbl %>% select(year, c_newinc_100k, iso3) %>% mutate(orphs=orphaned.dots(c_newinc_100k)) 

f.trend <- tra %>% ggplot(aes(year, c_newinc_100k, ymin=0)) + geom_line(size=1) + geom_point(data=subset(tra, orphs)) + theme_report() + labs(x="", y="Total new and relapse cases per 100 000 per year") + facet_wrap(~iso3, scales="free_y") + geom_smooth(method="loess") #+ scale_y_log10()

write.csv(tra, file=paste0(pasteLabel("./figure_data/table", figCount, "f.trend", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE, na="")

# For paragraph
tra %>% filter(year %in% c(2000, 2013)) %>% spread(year, c_newinc_100k) %>% mutate(decline=a.rate(`2000`, `2013`, 13)) %>% arrange((decline))

```


```{r f.agesex.data,  echo=FALSE}
figCount <- incCount(figCount, "f.agesex")

aga <- merge(subset(tbl, select=c("iso3", "country", "year", "g_whoregion", "g_hbc22", "newrel_m04", "newrel_m514", "newrel_m014", "newrel_m1524", "newrel_m2534", "newrel_m3544", "newrel_m4554", "newrel_m5564", "newrel_m65", "newrel_mu", "newrel_f04", "newrel_f514", "newrel_f014", "newrel_f1524",  "newrel_f2534", "newrel_f3544", "newrel_f4554", "newrel_f5564", "newrel_f65", "newrel_fu",
                                              "new_sp_m04", "new_sp_m514", "new_sp_m014", "new_sp_m1524", "new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", "new_sp_mu", "new_sp_f04", "new_sp_f514", "new_sp_f014", "new_sp_f1524",  "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65", "new_sp_fu",
                                              "new_sn_m04", "new_sn_m514", "new_sn_m014", "new_sn_m1524", "new_sn_m2534", "new_sn_m3544", "new_sn_m4554", "new_sn_m5564", "new_sn_m65", "new_sn_mu", "new_sn_f04", "new_sn_f514", "new_sn_f014", "new_sn_f1524",  "new_sn_f2534", "new_sn_f3544", "new_sn_f4554", "new_sn_f5564", "new_sn_f65", "new_sn_fu", 
                                              "new_ep_m04", "new_ep_m514", "new_ep_m014", "new_ep_m1524", "new_ep_m2534", "new_ep_m3544", "new_ep_m4554", "new_ep_m5564", "new_ep_m65", "new_ep_mu", "new_ep_f04", "new_ep_f514", "new_ep_f014", "new_ep_f1524",  "new_ep_f2534", "new_ep_f3544", "new_ep_f4554", "new_ep_f5564", "new_ep_f65", "new_ep_fu")), subset(p, select=c("iso3", "country", "year", "e_pop_m04", "e_pop_m514", "e_pop_m014", "e_pop_m1524", "e_pop_m2534", "e_pop_m3544", "e_pop_m4554", "e_pop_m5564", "e_pop_m65", "e_pop_f04", "e_pop_f514", "e_pop_f014", "e_pop_f1524", "e_pop_f2534", "e_pop_f3544", "e_pop_f4554", "e_pop_f5564", "e_pop_f65")))

# Aggregate for total
agb1 <- aggregate(aga[6:ncol(aga)], by=list(year=aga$year, area=aga$g_whoregion), FUN=sum, na.rm=TRUE)

agb1[c('iso3', 'g_hbc22', "area")] <- "LIC"
agb1$iso3 <- agb1$area
agb1$g_whoregion <- agb1$area
aga1 <- reshape::rename(aga,c('country'='area'))
agb <- rbind(aga1, agb1)

# Calculate rates

agc <- melt(agb, id=1:5)
# agc[c('new', 'type', 'group')] <- str_split_fixed(agc$variable, '_', n=3) # This takes me 25 seconds...it's the '_all' or '_fixed' that's the killer.
agc$type1 <- str_extract(agc$variable, 'newrel|pop|new_sp|new_sn|new_ep')
agc$age <- str_replace(agc$variable, "newrel_|e_pop_|new_sp_|new_sn_|new_ep_", "")
agc$sex <- str_replace(agc$age, '[u]|[0-9]+', "")
agc$age <- str_replace(agc$age, '[f]|[m]', "")

# aggregate all types for previous years
agc$type <- ifelse(agc$type1=="pop", "pop", "newrel")
agc$value <- as.numeric(agc$value) # avoid integer overflow
agd1 <- agc %>%
  group_by(iso3, area, year, g_whoregion, g_hbc22, type, age, sex) %>%
  summarise(value=sum0(value)) # %>%
agd <- cast(agd1, ...~type, value = "value")

agd$newrel_100k <- agd$newrel / agd$pop * 1e5

# Subset for WPRO
age <- subset(agd, (iso3 %in% lic | area=="LIC") & age!="u" & !age %in% c("04", "514"))
age$sex <- factor(age$sex, levels=c("m", "f"), labels=c("Male", "Female"))

age$age <- factor(age$age, c("014", "1524", "2534", "3544", "4554", "5564", "65"), c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", "\u2265 <65"))

p1 <- ggplot(subset(age, year>=1995 & iso3 %in% lic[1:3]), aes(year, newrel_100k, color=age)) + geom_line(size=1) + facet_grid(iso3~sex, scales='free_y') + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_color_brewer("Age group", type="seq", palette=4)

p2 <- p1 + scale_y_continuous("New and relapse cases per 100 000 per year") + geom_vline(aes(xintercept=c(2006, 2000)), color="red", alpha=.1)

# age only

agd1 <- agc %>%
  group_by(iso3, area, year, g_whoregion, g_hbc22, type, age) %>%
  summarise(value=sum0(value)) # %>%

agd <- cast(agd1, ...~type, value = "value")

agd$newrel_100k <- agd$newrel / agd$pop * 1e5

# Subset for WPRO
age <- subset(agd, (iso3 %in% lic | area=="LIC") & age!="u" & !age %in% c("04", "514"))
# age$sex <- factor(age$sex, levels=c("m", "f"), labels=c("Male", "Female"))

age$age <- factor(age$age, c("014", "1524", "2534", "3544", "4554", "5564", "65"), c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", ">\u2265 65"))

age$trnd.brk <- ifelse(age$iso3=="HKG" & age$year < 2005, "sp", "all")
age$trnd.brk <- ifelse(age$iso3!="HKG" & age$year < 2006, "sp", age$trnd.brk)

f.agesex <- ggplot(subset(age, year>=1995 & iso3 %in% lic[1:9]), aes(year, newrel_100k, color=age, width=trnd.brk)) + geom_line(size=1) + facet_wrap(~iso3, scales='free_y', nrow=3) + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_color_brewer("Age group", type="seq", palette=4) + scale_y_continuous("New and relapse cases per 100 000 per year") + guides(color = guide_legend(reverse = TRUE)) + theme(legend.text.align=1)

# NOtE: Can also do log y scale, but it just crushes the space and makes differences harder to see. But maybe more consistent with other graphs.

write.csv(age, file=paste0(pasteLabel("./figure_data/figure", figCount, "f.agesex", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

```

```{r f.migrant.data, include=FALSE}
figCount <- incCount(figCount, "f.migrant")

# Get migrant stock from world bank data

obc <- merge(tb, oba, by.x = c("iso2", "year"), by.y=c("iso2c", "year"))

obb <- obc %>%
  filter(iso3 %in% lic) %>% 
  mutate(migtb_pct=ifelse(year<2013, new_foreign, notif_foreign) / c_notified * 100) %>% # despite it's name "new_foreign" is among all notified cases.
  select(iso3, year, mig=SM.POP.TOTL.ZS, c_newinc_100k, migtb_pct) 
obd <- obb %>%
  filter(!is.na(mig), !is.na(c_newinc_100k))

# obe <- obc %>%
#   filter(g_wpr=="Other", g_whoregion=="WPR") %>% 
#   summarize(mig_ave=sum0(new_foreign) / c_notified * 100) %>% # despite it's name "new_foreign" is among all notified cases.
#   select(iso3, year, mig=SM.POP.TOTL.ZS, c_newinc_100k, migtb_pct) 

f.migrant.trend <- ggplot(obb, aes(year, migtb_pct, ymin=0)) + geom_point(aes(size=mig)) + geom_line() + theme_report() + scale_x_continuous("", limits=c(2007,2013)) + scale_y_continuous("Foreign-born TB cases (% of total notified)") + facet_wrap(~iso3, scales = "free_y") + scale_size("International migrant stock 2010 (% of population)") + theme(legend.position="bottom")

obq <- obb %>%
  mutate(mig=ifelse(year==2010, mig, NA), migtb_pct=ifelse(year==2013, migtb_pct, NA)) %>%
  group_by(iso3) %>%
  summarize(mig=sum0(mig), migtb_pct=sum0(migtb_pct)) %>%
ggplot(aes(mig, migtb_pct)) + geom_point(aes(color=iso3)) + geom_line(aes(x,y), data.frame(x=c(0,60), y=c(0,60)), alpha=0.2) + theme_report() + scale_x_continuous("International migrant stock 2010 (% of population)") + scale_y_continuous("Foreign-born TB cases 2013 (% of total notified)")

f.migrant <- direct.label(obq)


obq <- obb %>%
  mutate(mig=ifelse(year==2010, mig, NA), c_newinc_100k=ifelse(year==2013, c_newinc_100k, NA)) %>%
  group_by(iso3) %>%
  summarize(mig=sum0(mig), c_newinc_100k=sum0(c_newinc_100k)) %>%
ggplot(aes(mig, c_newinc_100k)) + geom_point(aes(color=iso3)) + geom_line(aes(x,y), data.frame(x=c(0,75), y=c(0,75))) + theme_report() + scale_x_continuous("International migrant stock 2010 (% of population)") + scale_y_continuous("New and relapse TB cases per 100 000 per year")

f.migrant.tbrate <- direct.label(obq)

write.csv(obb, file=paste0(pasteLabel("./figure_data/figure", figCount, "f.migrant", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)


# for paragraph
# h1 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% group_by(g_wpr) %>% summarize(prev=sum0(e_prev_num))
# h2 <- round(h1[1,2] / h1 %>% summarize(prev=sum(prev)) * 100)

```

```{r f.txout.data}
figCount <- incCount(figCount, "f.txout")

tra <- subset(tb, year %in% 2000:(yr-1) & iso3 %in% lic, select=c(iso3, year, new_sp_coh, new_sp_cur, new_sp_cmplt, new_sp_died, new_sp_fail, new_sp_def, newrel_coh, newrel_succ, newrel_died, newrel_fail, newrel_lost))

# trb <- aggregate(tra[3:ncol(tra)], by=list(year=tra$year), FUN=sum, na.rm=TRUE)
# trb$iso3 <- "WPR"

# trc <- rbind(tra, trb)

# trc$area <- factor(trc$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao People’s \nDemocratic Republic", "Mongolia", "Papua New Guinea", "Philippines", "Viet Nam", "WPR"))

trd <- tra %>% rowSumsNA2("succ", c("new_sp_cur", "new_sp_cmplt", "newrel_succ")) %>% rowSumsNA2("coh", c("new_sp_coh", "newrel_coh")) %>% mutate(success=succ/coh*100) %>% select(iso3, year, success) 






# trb$Success <- (trb$new_sp_cur + trb$new_sp_cmplt + trb$newrel_succ) / (trb$new_sp_coh + trb$newrel_coh) * 100
# trb$Died <- (trb$new_sp_died + trb$newrel_died) / (trb$new_sp_coh + trb$newrel_coh) * 100
# trb$Failed <- (trb$new_sp_fail + trb$newrel_fail) / (trb$new_sp_coh + trb$newrel_coh) * 100
# trb$Defaulted <- (trb$new_sp_def + trb$newrel_lost) / (trb$new_sp_coh + trb$newrel_coh) * 100
# trb$`Not evaluated` <- ((trb$new_sp_coh + trb$newrel_coh) - (trb$new_sp_cur + trb$new_sp_cmplt + trb$new_sp_died + trb$new_sp_fail + trb$new_sp_def)) / (trb$new_sp_coh + trb$newrel_coh) * 100
# 
# trc <- melt(trb[c("year", "Success", "Died", "Failed", "Defaulted", "Not evaluated")], id=1)



f.txout.line <- ggplot(trd, aes(year, success, color=iso3)) + geom_line(size=1) + theme_report() + geom_text(data=end.labels(trd, "year", "success", min.spread=2.1), aes(label=iso3), hjust=-0.2, vjust=0, size=4)  + scale_y_continuous("Percent of cohort successfully treated") + scale_x_continuous("", limits=c(2000,2012.7)) + coord_cartesian(ylim=c(0,100)) + scale_size_discrete(range = c(1,1.5)) + theme(legend.position="none") + scale_color_brewer(type="qual", palette=6)  + guides(fill = guide_legend(reverse = TRUE))

# old school

trb <- subset(tb, year %in% 2000:(yr-1) & iso3 %in% lic, select=c(year, iso3, new_sp_coh, new_sp_cur, new_sp_cmplt, new_sp_died, new_sp_fail, new_sp_def, newrel_coh, newrel_succ, newrel_died, newrel_fail, newrel_lost))

# trb <- aggregate(tra[2:ncol(tra)], by=list(year=tra$year), FUN=sum, na.rm=TRUE)

trb$coh <- rowSumsNA(trb[c("new_sp_coh", "newrel_coh")])

trb$Success <- rowSumsNA(trb[c("new_sp_cur", "new_sp_cmplt", "newrel_succ")]) / trb$coh * 100
trb$Died <- rowSumsNA(trb[c("new_sp_died", "newrel_died")]) / trb$coh * 100
trb$Failed <- rowSumsNA(trb[c("new_sp_fail", "newrel_fail")]) / trb$coh * 100
trb$`Lost to follow-up` <- rowSumsNA(trb[c("new_sp_def", "newrel_lost")]) / trb$coh * 100
trb$`Not evaluated` <- (trb$coh - rowSumsNA(trb[c("new_sp_cur", "new_sp_cmplt", "newrel_succ", "new_sp_died", "newrel_died", "new_sp_fail", "newrel_fail", "new_sp_def", "newrel_lost")])) / trb$coh * 100


trc <- melt(trb[c("year", "iso3", "Success", "Died", "Failed", "Lost to follow-up", "Not evaluated")], id=1:2)

# trc <- trc %>% group_by(country, year) %>% mutate(value2=ifelse(is)) 

trc$value <- ifelse(is.na(trc$value) & ((trc$iso3=="NZL" & trc$year==2010) | (trc$iso3=="MYS" & trc$year==2002)), 0, trc$value)

f.txout.bar <- ggplot(trc, aes(year, value, fill=variable)) + geom_bar(stat="identity", position="stack") + facet_wrap(~iso3, scales="free_y") + theme_report() + scale_fill_brewer('Outcome', type="qual", palette=6) + scale_x_continuous("") + scale_y_continuous("Percent of cohort") + coord_cartesian(ylim=c(0,100)) + guides(fill = guide_legend(reverse = TRUE))


f.txout <- ggplot(trc, aes(year, value, fill=variable)) + geom_area(stat="identity", position="stack", na.rm = FALSE) + facet_wrap(~iso3, scales="fixed") + theme_report() + scale_fill_brewer('Outcome', type="qual", palette=6) + scale_x_continuous("", breaks=c(2000,2005,2010)) + scale_y_continuous("Percent of cohort") + coord_cartesian() + guides(fill = guide_legend(reverse = TRUE))


# For stack overflow
require(dplyr)
require(ggplot2)

set.seed(1)

test <- data.frame(x=rep(1:10,3), y=abs(rnorm(30)), z=rep(LETTERS[1:3],10)) %>% arrange(x,z)

test[test$x==4,"y"] <- NA

# ggplot(test, aes(x, y, fill=z)) + geom_area(stat="identity", position="stack", na.rm=TRUE) 

# ggplot(test, aes(x, y, fill=z)) + geom_area(stat="identity", position="stack", na.rm=FALSE) 

# ggplot(test, aes(x, y, fill=z)) + geom_bar(stat="identity", position="stack") 

# ylim=c(0,100)

write.csv(trc, file=paste0(pasteLabel("./figure_data/figure", figCount, "f.txout", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

# for paragraph 

# This can be replaced when the new data file is here (~2015)
tb2 <- tb
if(is.null(head(tb2$c_tsr))) tb2$c_tsr <- NA

n30 <- tb2 %>% filter(year==yr-1, g_whoregion=="WPR") %>% mutate(tsr=ifelse(!is.na(c_tsr), c_tsr, ifelse(!is.na(c_newrel_tsr), c_newrel_tsr, c_new_tsr))) %>% arrange(desc(tsr)) %>% select(country, iso3, tsr, newrel_coh, newrel_succ, newrel_fail, newrel_died, newrel_lost) %>% filter(tsr>0)
n31 <- n30 %>% filter(tsr >=85) %>% nrow()
n32 <- n30 %>% filter(iso3 %in% lic) %>% mutate(tsr=signif(tsr,2))
n33 <- n32 %>% filter(tsr==last(tsr)) %>% mutate(neval=newrel_coh - sum(newrel_succ, newrel_fail, newrel_died, newrel_lost), l=signif(sum(newrel_lost, neval) / newrel_coh * 100, 2)) %>% select(l) %>% mutate(l=ifelse(l %in% 22:25, "approximately a quarter", ifelse(l %in% 25:29, "over a quarter", paste0(l, "%"))))
n34 <- tbl %>% mutate(idef=signif((c_newinc-newrel_coh)/c_newinc * 100, 2)) %>% filter(year==yr-1, iso3 %in% lic, idef > 2) %>% select(country, idef) %>% arrange(desc(idef)) 
n35c <- paste(paste(n34[1:(nrow(n34)-1),"country"], collapse=", "), n34[nrow(n34),"country"], sep=" and ")
n35n <- paste(paste(n34[1:(nrow(n34)-1),"idef"], collapse=", "), n34[nrow(n34),"idef"], sep=" and ")

```

```{r f.tbhiv.data}

figCount <- incCount(figCount, "f.tbhiv")

tha <- subset(tb, year >= 2005 & g_whoregion=="WPR" & iso3 %in% lic, select=c("country", "year", "iso3", "g_hbc22", "c_notified", "hivtest", "hivtest_pos", "hiv_cpt", "hiv_art", "hivtest_pct_numerator", "hivtest_pct_denominator", "hivtest_pos_pct_numerator", "hivtest_pos_pct_denominator", "hiv_cpt_pct_numerator", "hiv_cpt_pct_denominator", "hiv_art_pct_numerator", "hiv_art_pct_denominator"))

# tha2 <- aggregate(tha1[5:ncol(tha1)], by=list(year=tha1$year), FUN=sum, na.rm=TRUE)
# tha2[c("country", "iso3")] <- "WPR"
# tha2[c("g_hbc22")] <- NA
# tha <- rbind(tha1, tha2)

tha$test <- tha$hivtest_pct_numerator / tha$hivtest_pct_denominator * 100
tha$pos <- tha$hivtest_pos_pct_numerator / tha$hivtest_pos_pct_denominator * 100
tha$cpt <- tha$hiv_cpt_pct_numerator / tha$hiv_cpt_pct_denominator * 100
tha$art <- tha$hiv_art_pct_numerator / tha$hiv_art_pct_denominator * 100

thb <- melt(tha[c("iso3", "year", "test", "pos", "cpt", "art")], id=1:2) %>%
  mutate(orphs=orphaned.dots(value))

thb$variable <- factor(thb$variable, levels=c("test", "pos", "cpt", "art"), labels=c("HIV testing \namong TB patients", "HIV-positive among \nTB patients tested", "CPT coverage \namong co-infected", "ART coverage \namong co-infected"))

f.tbhiv <- ggplot(thb, aes(year, value)) + geom_line(size=1) + geom_point(data=subset(thb, orphs)) + facet_grid(variable~iso3, scales="free") + theme_report() + labs(y="Percent", x="") + scale_x_continuous(breaks=c(2005, 2010))

write.csv(thb, file=paste0(pasteLabel("./figure_data/figure", figCount, "f.tbhiv", insLink=FALSE, sepper=""), ".csv"), row.names=FALSE)

```




<sup>&dagger;</sup> Stop TB and Leprosy Elimination, Division of Communicable Diseases, World Health Organization Regional Office for the Western Pacific, Manila, Philippines.

--------------------------------------------------------

Correspondence to Tom Hiatt (e-mail: hiattt@wpro.who.int).

--------------------------------------------------------

To cite this article: 



--------------------------------------------------------

Abstract 
--------------------------------------------------------
```{r abstract, echo=FALSE}
a1 <- signif((subset(esta, year==2000, e_prev_num) - subset(esta, year==yr, e_prev_num)) / subset(esta, year==2000, e_prev_num) * 100, 2)
a2 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(cases=sum0(c_notified / 1e6)) %>% signif(2)
a3 <- tb %>% filter(year==yr-1, g_whoregion=="WPR", c_newrel_tsr >= 85) %>% nrow()

```

[To be written after the rest of the text.]

TB surveillance data, within inherent limitations, is an important source of programmatic and epidemiological information. Careful interpretation of these findings can provide useful insight for programmatic decision-making.

--------------------------------------------------------

Introduction
--------------------------------------------------------
```{r intro, echo=FALSE}
i1 <- signif(subset(esta, year==2000, e_prev_num) / 1e6, 2)
i2 <- signif(subset(esta, year==yr, e_prev_num) / 1e6, 2)
i2a <- signif(sum0(subset(tb, g_whoregion=="WPR" & year >= 2000, c_newinc)) / 1e6, 3)
i3 <- tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(cases=sum0(c_notified / 1e6)) %>% signif(2)
```

The End TB Strategy, adopted by the World Health Assembly in 2014,[cite] expands the scope of TB control beyond countries with a high burden of TB to also include countries and areas with a low and intermediate burden of the disease. The challenges faced by these countries are diverse and often require innovative solutions. WHO released guidelines toward TB elimination in countries that have a low burden of disease,[cite] which requires concerted efforts on marginalized and vulnerable populations. In the World Health Organization (WHO) Western Pacific Region, significant progress has been made in the past few decades including among higher-income countries with a lower disease burden. Analysis of TB data from these countries provides an opportuntity to assess progress and inform future directions.

This article is part of complementary analyses conducted in conjunction with the regional analysis of 2013 TB case notification data.[cite] 



Methods
--------------------------------------------------------
```{r methods, echo=FALSE}
m1 <- lister(unique(tbl$country), ";")
m2 <- signif(tbl %>% filter(year==yr) %>% summarize(pop=sum(e_pop_num)) / tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(pop=sum(e_pop_num)) * 100,3)
m2b <- signif(tbl %>% filter(year==yr) %>% summarize(notif=sum0(c_notified)) / tb %>% filter(year==yr, g_whoregion=="WPR") %>% summarize(pop=sum0(c_notified)) * 100,3)

m3 <- tbl %>% filter(year %in% 2012) %>% mutate(nd=new_su / c_newinc * 100) %>% group_by(country) %>% summarize(ndo=round(max(nd),0)) %>% arrange(desc(ndo)) %>% head(3) %>% as.data.frame() 
m4 <- paste(paste(m3[1:(nrow(m3)-1),"country"], collapse=", "), m3[nrow(m3),"country"], sep=" and ")
m5 <- paste(paste(m3[1:(nrow(m3)-1),"ndo"], collapse=", "), m3[nrow(m3),"ndo"], sep=" and ")
m6 <- tbl %>% filter(year %in% 2012, g_whoregion=="WPR") %>% group_by(year) %>% summarize(new_su=sum0(new_su), c_newinc=sum0(c_newinc), nd=signif(new_su/c_newinc  * 100,2)) %>% arrange(desc(nd)) %>% head(1) %>% select(nd) 


info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

Of the 36 countries and areas in the Region which are requested to submit annual reports of TB surveillance data, seven are considered high-burden countries for TB and an additional 20 are Pacific islands. The remaining nine low- and intermediate-burden countries and areas in the Region (LICs) are the focus of this analysis, namely: `r m1`.

### Data
Methods of data collection have evolved since WHO began routinely collecting TB data. Since 2009, a web-based online system has been used for data submission and validation. Collected data covers the following areas: TB case notifications and treatment outcomes, diagnostic and treatment services, drug management, surveillance and surveys of drug-resistance, information on TB/HIV co-infection, infection control, engagement of all care providers and budgets and expenditures for TB control. The full description of methods is available in the Global Tuberculosis Report[@WorldHealthOrganization2014] and the data sets are available from the WHO global TB database (www.who.int/tb/data). Case definitions for TB were revised in 2013[@WorldHealthOrganization2013] and cases previously known as smear-positive are now included in laboratory-confirmed cases. The revised case definitions combine smear-negative cases with all clinically diagnosed cases and therefore obscure the number of cases where smear was not done or results are unknown. In 2012 for these LICs, `r m6`% of cases did not have a smear result. At the country level, the proportion was as high as `r m5` percent  in `r m4`, respectively.

For `r yr`, all nine LICs of the Western Pacific Region reported data representing `r m2`% of the Regional population. 

### Analysis and reproducibility
Analysis was conducted by the statistical package R (ver. `r r_ver`, R Core Team, `r info$R.version$year`, Vienna, Austria, www.R-project.org). Due to calls for transparent and reproducible research,[@Peng2006; @Groves2012] we have published programme code to generate the entire contents of this article including all figures and tables by using R with the knitr package (ver. `r info$otherPkgs$knitr$Version`, Yihui Xie, `r format.Date(info$otherPkgs$knitr$Date, "%Y")`). Readers can download the code (see supplement material) and reproduce all figures and tables under an appropriate personal computing environment. For non-commercial purposes, readers may modify the code to produce figures and tables that are not presented in this article. For instance, readers may wish to produce tables and figures for countries or regions other than the WHO Western Pacific Region.



Results
--------------------------------------------------------
```{r results, include=FALSE}


```


### Case notification

In `r yr`, LICs in the Region reported `r n1` people with TB disease (`r I(pasteLabel("Table", tableCount, "t.notif"))`). This accounts for `r m2b`% of the regional burden. New and relapse cases (new episodes of TB) accounted for 95.5% of those notified. Cases were bacteriologically confirmed in 72% of LIC cases, ranging from 64% in Singapore to 95% in Brunei Darussalam. The proportion of extrapulmonary cases formed the LICs into three groups, high proportions of over 40% in Australia and New Zealand, low proportions in China, Macao SAR, Malaysia and Singapore with less than 15%, and the remaining LICs around 20%. Relapse cases comprise about 9% of cases in these countries with a comparatively narrow spread between LICs. Other retreatment cases have a larger range with the highest proportion in the Republic of Korea (8.2%). All proportions presented are higher in LICs than the WPR average.

 

--------------------------------------------------------

<a id="t.notif"></a> 
**`r I(pasteLabel("Table", tableCount, "t.notif", insLink=FALSE))`. Tuberculosis case notification from countries and areas of the Western Pacific Region, `r yr`**  
```{r t.notif, results='asis'}

# How about changing ep to %. compare these areas with the regional average for. % ep, % relapse, % lab confirmed, 

print(tbm, type="html", include.rownames=FALSE, include.colnames=FALSE, html.table.attributes="border=0 rules=rows width=700 cellpadding=15", add.to.row=list(pos=list(0, nrow(tbm)), command=c(
  "<TR> 
  <TD colspan='1' style='border-right: solid 1px black;'></TD> 
  <TH colspan='4' style='border-right: solid 1px black;'>NEW AND RELAPSE<sup>a</sup></TH> 
  <TH colspan='2'></TH> 
  </TR> 
  <TR> 
  <TD style='border-right: solid 1px black;'></TD> 
  <TD style='width:75px'>TOTAL</TD> 
  <TD>BACTERIOLOGICALLY CONFIRMED AMONG PULMONARY CASES (%)</TD> 
  <TD>EXRAPULMONARY (%)</TD> 
  <TD style='border-right: solid 1px black;'>RELAPSE (%)</TD> 
  <TD style='width:75px'>TOTAL NOTIFIED</TD>
  <TD>RETREATMENT EXCLUDING RELAPSE AMONG NOTIFIED (%)</TD> 
  </TR> 
  <TR>", 
  "<TR> <TD colspan=7>Blank cells indicate data not reported.<br>
  <sup>a</sup> NEW AND RELAPSE includes cases for which the treatment history is unknown.</TD></TR>")))

```  

--------------------------------------------------------

`r I(pasteLabel("Figure", figCount, "f.spread"))` displays the differences between LICs. New and relapse TB notification rates are mapped to a horizontal log scale to better show the natural progression as disease burden decreases. The verticle scale shows the actual burden per year. Japan, with the largest population, sits in the middle of this spread of TB rates with an existing burden of over 20 thousand cases per year. Australia and New Zealand have comparatively lower burdens of TB in terms of proportion and absolute numbers. Brunei Darussalum, China, Hong Kong SAR, China, Macao SAR, and Singapore have higher proportions of TB, but a comparatively lower absolute burden. With similar, but slightly higher proportions, Malaysia and the Republic of Korea have much higher case loads due to their larger populations with over 23 and 41 thousand cases, respectively. 

--------------------------------------------------------

<a id="f.spread"></a> 
**`r I(pasteLabel("Figure", figCount, "f.spread", insLink=FALSE))`. New and relapse TB cases, absolute number and proportion per 100 000 population, `r yr`**  
```{r f.spread, fig.height=5, warning=FALSE}
f.spread
```

AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------

Case notification rates have mostly trended downward since 1980, with the exception of rates in Malaysia and the Republic of Korea which have been increasing since 2004 and 2000, respectively (`r I(pasteLabel("Figure", figCount, "f.trend"))`). Trends have tapered off in recent years in Australia, Brunei Darussalam, the Republic of Korea, and China, Macao SAR. The trend in Singapore also appears to have reached a point of stagnation, possibly even beginning to increase. Since 2000, the greatest annual rate of decline is seen in Japan (5.0%).



--------------------------------------------------------

<a id="f.trend"></a> 
**`r I(pasteLabel("Figure", figCount, "f.trend", insLink=FALSE))`. Tuberculosis case notification rate (all forms and new laboratory-confirmed) per 100 000 population in select countries of the Western Pacific Region, 2000--`r yr`**  
```{r f.trend, fig.height=5, warning=FALSE}
f.trend
```

AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------

#### Age-specific notification rates

The breakdown of cases by age group, including both native- and foreign-born, are presented in `r I(pasteLabel("Figure", figCount, "f.agesex"))`. All countries besides Australia and New Zealand show a distinct gap between the oldest and the remaining age groups. Most of these countries show a consecutive decrease with younger age groups with the most clear distinction seen in Malaysia since 2003. TB among children under 15 is substantially lower than the next eldest age group in all settings.


--------------------------------------------------------

<a id="f.agesex"></a> 
**`r I(pasteLabel("Figure", figCount, "f.agesex", insLink=FALSE))`. Trend of age group-specific notification rates (per 100 000 population) of new and relapse^a^ tuberculosis cases in select countries of the Western Pacific Region, 1995--`r yr`**  
``` {r f.agesex, warning=FALSE, fig.width=9, fig.height=10}
f.agesex
```

^a^ Rates prior to 2013 include new cases only and prior to 2006 (2005 for HKG) include smear-positive cases only. Other gaps indicate data not reported.

AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------


#### Migration

The proportion of TB cases and of the general population that are foreign-born ranges greatly amongst the LICs (`r I(pasteLabel("Figure", figCount, "f.migrant"))`). The proportion of TB cases foreign-born is much higher than in the general population in Australia and New Zealand, whereas in the special administrative regions of China, it is much lower. The remaining five LICs have proportions similar between the two groups, although Brunei Darussalam and Singapore have much higher proportions.

--------------------------------------------------------

<a id="f.migrant"></a> 
**`r I(pasteLabel("Figure", figCount, "f.migrant", insLink=FALSE))`. Foreign-born TB cases and international migrant stock in nine countries of the Western Pacific Region, 2007--`r yr`**  
```{r f.migrant, fig.height=5, warning=FALSE}
f.migrant
```

Diagonal line indicates equal proportions on horizontal and vertical scales.
International migrant stock data from World Development Indicators, World Bank.

AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------

#### Treatment outcomes

For the 2012 cohort as see in `r I(pasteLabel("Figure", figCount, "f.txout"))`, the proportion of patients successfully treated was highest in China, Macao SAR (88.3%) and lowest in Japan (54.1%). Patients not evaluated was the most common unfavourable treatment outcome, followed by death and lost to follow-up. Death rates were highest in China, Hong Kong SAR (17.1%) and Japan (16.5%). The rates of lost to follow-up were highest in the Republic of Korea (10.0%), Japan (6.7%) and Malaysia (5.0%). Trends show some consistency in treatment success alongside considerable variation over time in the causes of unfavourable outcomes.

--------------------------------------------------------

<a id="f.txout"></a> 
**`r I(pasteLabel("Figure", figCount, "f.txout", insLink=FALSE))`. Trend of treatment outcome expressed as a proportion among new laboratory-confirmed cases in the Western Pacific Region, 2000--`r yr-1`**  
``` {r f.txout, fig.width=9, warning=FALSE}
f.txout
```

AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------

#### TB/HIV

HIV testing among TB patients is high or increasing in all LICs except Japan (`r I(pasteLabel("Figure", figCount, "f.tbhiv"))`). The number of TB/HIV cases found remains low and decreasing, again with the exception of Japan. Co-trimoxazole preventive therapy (CPT) and antiretroviral 
therapy (ART) coverage is largely unreported and low in most LICs, except Brunei Darussalam (also unreported for the latest year).  

--------------------------------------------------------

<a id="f.tbhiv"></a> 
**`r I(pasteLabel("Figure", figCount, "f.tbhiv", insLink=FALSE))`. Progress in TB/HIV activities in select countries in the Western Pacific Region, 2005--`r yr`**  
``` {r f.tbhiv, fig.width=9, fig.height=7, warning=FALSE}
f.tbhiv
```

Gaps and empty panels indicate data not reported.

CPT=co-trimoxazole preventive therapy; ART=antiretroviral 
therapy; AUS=Australia; BRN=Brunei Darussalam; HKG=China, Hong Kong SAR; JPN=Japan; KOR=Republic of Korea; MAC=China, Macao SAR; MYS=Malaysia; NZL=New Zealand; SGP=Singapore.

--------------------------------------------------------



Discussion
--------------------------------------------------------

```{r discussion}


# for paragraph
# d1 <- estd %>% filter(year==yr) %>% mutate(c=signif(c_newinc / 1e6, 2), r=signif(c_newinc_100k,2)) %>% select(c, r)

  
```


The TB burden found in these nine LICs, while comparatively small, still represents nearly 100 000 cases in the Region. As these countries are wealthier than the regional average, the higher levels of bacteriological confirmation may be attributed to the greater availability of more sensitive diagnostics. As noted above, the proportion of cases which did not receive confirmatory testing is unknown, but likely not insignificant. The proportion of extrapulmonary at two and a half times the regional average may also be a result of more sophisticated diagnostics and increased ability to detect these cases. The higher levels of retreatment cases, including relapse, give some indication that active transmission is lower in these settings.

The epidemiological situation amongst the LICs is varied and suggests diverse strategies for controlling TB. Australia and New Zealand meet the criteria of less than 10 cases per 100 000 identified for targeting elimination.[cite] Similar to other countries with a low burden, the challenge of providing effective TB services for migrants should be prioritized if elimination is to be realized. 

Where active transmission has been mostly removed, the highest TB rates are seen in the elderly due to reactivation and in migrants due to infection occuring in their country of departure. The majority of migrants are younger and `r I(pasteLabel("Figure", figCount, "f.agesex"))` provides a clue as to when the burden of TB shifts to migrants from the native elderly population. The gap in many LICs between the oldest and the younger age groups also hints at the remains of a peak in transmission during the mid-twentieth century. The gap between the youngest age group and the rest may be a result of underdiagnosis in this age group. [is there any epidemiological explanation for this?]

Migration continues to be a key issue for TB control, although with the exception of Australia and New Zealand, the majority of TB cases are not in migrant populations (`r I(pasteLabel("Figure", figCount, "f.migrant"))`). As the proportion of infected individuals amongst the elderly decreases in Singapore and Brunei Darussalam, effective TB services for migrant populations will become more important. In Japan, Malaysia and the Republic of Korea, the vast majority of TB cases are in the native-born population. 

Treatment failure is considerably low in recent years and the number of unevaluated cases is reducing (`r I(pasteLabel("Figure", figCount, "f.txout"))`). Treatment success is still low in most LICs, which may be attributable to complications surrounding TB treatment for the elderly. Patients lost to follow-up is still a problem, especially in Japan, Malaysia and the Republic of Korea. HIV testing is mostly over 50% and rising (`r I(pasteLabel("Figure", figCount, "f.tbhiv"))`). The proportion of TB/HIV cases found is low indicating a good level of testing coverage. CPT and ART coverage, however, should receive more attention as proportions are well below 100%.

This analysis provides a snapshot of the epidemiological and programmatic situation of TB in these select countries and areas based on the case notification data in `r yr`. As for any disease surveillance system, the analysis of surveillance data has inherent limitations. TB surveillance covers populations served by care providers linked with the national TB programme. Ideally this would include all known cases in the country; in practice the proportion of cases diagnosed outside of the TB programme and included in national reporting varies depending on the legal framework in the country. The WHO TB Impact Measurement Task Force recommends that countries continuously improve surveillance systems until reported cases can be considered a reliable proxy for incidence.[@WorldHealthOrganization2009; @WorldHealthOrganization2014b] A careful assessment is needed of programmatic progress in the country and the quality of surveillance data when interpreting these findings.

TB surveillance continues to be an important source of information for assessing the situation and measuring the progress for decision-making. WHO Regional Office for the Western Pacific will continue to conduct regional analyses on various topics related to TB epidemiology and programmatic progress. WHO continues to provide open access to the global TB database for additional analysis.



--------------------------------------------------------

**<em>Funding</em>**

None.

--------------------------------------------------------

**<em>Conflict of interest</em>**

None declared.

--------------------------------------------------------

**<em>Acknowledgement</em>**

The authors are very grateful to the national tuberculosis control programmes of the countries of the Western Pacific Region.

--------------------------------------------------------

**<em>References:</em>**

```{r magic copier, include=FALSE, echo=FALSE}
# Bit to copy html file over
# file.copy("D:/Users/hiattt/Dropbox/Code/Surveillance reports/LowInc.html", "D:/Users/hiattt/Dropbox/STB-WPRO/WPSAR surveillance paper/LIburden.html", overwrite = TRUE)
```
